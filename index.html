
<!doctype html>
<html lang="es">
>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aqu√≠ Nom√°s ‚Äî Demo (versi√≥n frases naturales)</title>
<style>
  :root{--pri:#0b5cff;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#0b1220}
  .wrap{max-width:860px;margin:0 auto;padding:18px}
  h1{font-size:20px;margin:0 0 14px}
  .box{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:14px;margin:0 0 14px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .input{flex:1;min-width:260px;padding:12px 14px;border:1px solid #cfd6e0;border-radius:12px;font-size:15px}
  .btn{padding:12px 14px;border-radius:12px;border:1px solid var(--pri);background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
  .btn.secondary{background:#fff;color:var(--pri)}
  .btn.ghost{background:#fff;border-color:#cfd6e0;color:#0b1220}
  .btn.mic{border:1px dashed var(--pri);background:#eef3ff}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{background:#eef3ff;border:1px solid #d7e3ff;color:#153a9b;padding:6px 10px;border-radius:999px;font-size:12px}
  .chip strong{font-weight:700;margin-right:4px}
  .tiny{font-size:12px;color:#667}
  .card{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:12px;margin:10px 0}
  .title{font-weight:700;margin-bottom:4px}
  .title span{font-weight:600;color:#555}
  .promo{margin:6px 0 10px;color:var(--pri)}
  .empty{padding:12px;color:#666}
</style>
</head>
<body>
<div class="wrap">
  <h1>üè∑Ô∏è Aqu√≠ Nom√°s ‚Äî demo (frases naturales)</h1>

  <div class="box">
    <div class="row">
      <input id="qall" class="input" autofocus placeholder="Ej: 'estoy en el centro y quiero almorzar'" />
      <button id="micBtn" class="btn mic" title="Dictar por voz (Chrome/Edge)">üé§</button>
      <button id="goBtn" class="btn">Buscar</button>
      <button id="clearBtn" class="btn ghost">Limpiar</button>
      <button id="cpyBtn" class="btn secondary">Copiar link</button>
    </div>
    <div class="chips" id="chips"></div>
    <div class="tiny" style="margin-top:8px">
      Prob√° decir o escribir frases naturales como:  
      <em>‚Äúestoy en el centro y quiero almorzar‚Äù</em> o  
      <em>‚Äúalmorzar en Devoto‚Äù</em>.
    </div>
  </div>

  <div id="results" class="box"></div>
</div>

<script>
// === PEG√Å AC√Å TU LINK PUBLICADO (Google Sheets ‚Üí ‚ÄúPublicar en la web‚Äù, termina en output=csv)
const CSV_URL =  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTsfhmidUT4vOSY5u0TCi_7IlrpRcYi29_VF2-qgQniySHAfG18eNYoyvQ_Bqf0iB6nZaOaSXGBqUXP/pub?gid=0&single=true&output=csv";
// ===============================================================================

// Stopwords
const STOP = new Set(["hola","buenas","buenos","dias","tardes","noches","necesito","quiero","busco","busca","buscar","buscando","buscaba","comprar","venta","un","una","de","para","con","el","la","los","las","en","por","y","o","a","al","del","estoy","estamos","aca","aqui","ahora","cerca","porfavor","porfa"]);
const RUBRO = {"resma":"Librer√≠a","papel":"Librer√≠a","hojas":"Librer√≠a","a4":"Librer√≠a","libros":"Librer√≠a","clavos":"Ferreter√≠a","tornillos":"Ferreter√≠a","flor":"Florer√≠a","flores":"Florer√≠a"};
const norm = s => (s||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
function toks(s){return norm(s).replace(/[^\p{L}\p{N}\s]/gu," ").split(/\s+/).filter(t=>t && !STOP.has(t));}
function parseCSV(txt){const rows=txt.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));const head=rows.shift().map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));return rows.map(r=>Object.fromEntries(head.map((h,i)=>[h,(r[i]||"").trim()])))}

// ‚Äî‚Äî interpretador flexible de frases ‚Äî‚Äî 
function understand(raw){
  const t0=(raw||"").trim(); const t=norm(t0);
  let zona="", qText=t0;

  // 1. "estoy en / vivo en / me encuentro en ..." + lo que venga hasta verbos comunes
  let m=t.match(/(?:estoy|vivo|me\s+encuentro)\s+en\s+(.+?)(?=\s+(?:busc\w*|necesit\w*|quiero|ir|comer|almorzar|cenar)\b|[,.!?]|$)/i);
  // 2. o "en|por|de <zona>" seguido de "y quiero" u otras acciones
  if(!m) m=t.match(/(?:^|\s)(?:en|por|de)\s+([a-z√°√©√≠√≥√∫√±\s]+?)(?=\s*(?:y\s+(?:busc\w*|necesit\w*|quiero|ir|comer|almorzar|cenar)|[,.!?]|$))/i);
  // 3. o al final de la frase: "almorzar en devoto"
  if(!m) m=t.match(/(?:almorzar|cenar|comer|buscar|ir|comprar|necesito|quiero)\s+(?:algo\s+)?en\s+([a-z√°√©√≠√≥√∫√±\s]+)$/i);

  if(m){zona=m[1].trim().split(/\s+/).slice(0,4).join(" ");qText=t0.replace(new RegExp(m[0],'i'),'').trim();}

  qText=qText
    .replace(/^(?:hola|buenas|buenos dias|buenas tardes|buenas noches)\b[\s,]*/i,"")
    .replace(/^(?:estoy|estamos|vivo|me\s+encuentro)\b[\s,]*/i,"")
    .replace(/^(?:busc\w*|necesit\w*|quiero|ir|comer|almorzar|cenar)\b[\s,]*/i,"")
    .replace(/^de\s+/i,"").trim();

  return {q:qText,z:zona};
}

let DATA=[];
fetch(CSV_URL).then(r=>r.text()).then(t=>{DATA=parseCSV(t);});

document.getElementById('goBtn').addEventListener('click',buscar);
document.getElementById('clearBtn').addEventListener('click',limpiar);
document.getElementById('cpyBtn').addEventListener('click',()=>{
  const inp=document.getElementById('qall').value.trim();
  const u=new URL(location.href);
  if(inp)u.searchParams.set('t',inp);else u.searchParams.delete('t');
  navigator.clipboard.writeText(u.toString()).then(()=>alert('Link copiado'));
});
document.getElementById('qall').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();buscar();}});

function buscar(){
  const raw=document.getElementById('qall').value;
  const {q,z}=understand(raw);
  document.getElementById('chips').innerHTML=[
    z?`<div class="chip"><strong>Zona:</strong> ${z}</div>`:'',
    q?`<div class="chip"><strong>Intenci√≥n:</strong> ${q}</div>`:''
  ].join('');
  render(buscarInterno(q,z));
}

function buscarInterno(q,z){
  const qt=toks(q),zt=norm(z);
  return DATA.map(l=>{
    const blob=norm(Object.values(l).join(" "));
    let score=0;qt.forEach(t=>{if(blob.includes(t))score++;});
    if(zt && !(l.barrio||"").toLowerCase().includes(zt))score=-1;
    return{l,score};
  }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0,8).map(x=>x.l);
}

function render(items){
  const box=document.getElementById('results');
  if(!items.length){box.innerHTML='<div class="empty">No encontr√© opciones. Prob√° con otra palabra o zona.</div>';return;}
  box.innerHTML=items.map(r=>{
    const wa=r.whatsapp?("https://wa.me/54"+String(r.whatsapp).replace(/[^0-9]/g,"")):null;
    const maps="https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(`${r.direccion||''} ${r.barrio||''}`);
    return`
      <div class="card">
        <div class="title">${r.nombre_local||'(sin nombre)'} ‚Äî <span>${r.rubro||''}</span></div>
        <div>${r.direccion||''} ${r.barrio?`(${r.barrio})`:''}</div>
        ${r.horario?`<div>Horario: ${r.horario}</div>`:''}
        ${r.promo_texto?`<div class="promo">Promo: ${r.promo_texto}</div>`:''}
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          ${wa?`<a class="btn" target="_blank" href="${wa}">WhatsApp</a>`:''}
          <a class="btn secondary" target="_blank" href="${maps}">C√≥mo llegar</a>
        </div>
      </div>`;}).join("");
}

function limpiar(){
  document.getElementById('qall').value="";
  document.getElementById('chips').innerHTML="";
  document.getElementById('results').innerHTML="";
}

// Micr√≥fono simple
(function(){
  const btn=document.getElementById('micBtn');
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){btn.disabled=true;btn.innerText='üé§‚Äî';btn.title='Dictado no disponible.';return;}
  const rec=new SR();rec.lang='es-AR';rec.interimResults=false;rec.maxAlternatives=1;
  btn.addEventListener('click',()=>{try{rec.start();btn.innerText='‚è∫Ô∏è';}catch(e){}});
  rec.onresult=e=>{const t=e.results[0][0].transcript||'';document.getElementById('qall').value=t.trim();buscar();};
  rec.onend=()=>{btn.innerText='üé§';};
  rec.onerror=()=>{btn.innerText='üé§';};
})();
</script>
</body>
</html>
