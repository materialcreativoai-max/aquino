
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aqu√≠ Nom√°s ‚Äî Demo (1 input)</title>
<style>
  :root{--pri:#0b5cff;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#0b1220}
  .wrap{max-width:860px;margin:0 auto;padding:18px}
  h1{font-size:20px;margin:0 0 14px}
  .box{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:14px;margin:0 0 14px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .input{flex:1;min-width:260px;padding:12px 14px;border:1px solid #cfd6e0;border-radius:12px;font-size:15px}
  .btn{padding:12px 14px;border-radius:12px;border:1px solid var(--pri);background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
  .btn.secondary{background:#fff;color:var(--pri)}
  .btn.ghost{background:#fff;border-color:#cfd6e0;color:#0b1220}
  .btn.mic{border:1px dashed var(--pri);background:#eef3ff}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{background:#eef3ff;border:1px solid #d7e3ff;color:#153a9b;padding:6px 10px;border-radius:999px;font-size:12px}
  .chip strong{font-weight:700;margin-right:4px}
  .tiny{font-size:12px;color:#667}
  .card{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:12px;margin:10px 0}
  .title{font-weight:700;margin-bottom:4px}
  .title span{font-weight:600;color:#555}
  .promo{margin:6px 0 10px;color:var(--pri)}
  .empty{padding:12px;color:#666}
  pre.debug{white-space:pre-wrap;background:#fff;border:1px solid #e6e9ee;border-radius:12px;padding:12px;margin-top:8px;font-size:12px;color:#333;display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>üè∑Ô∏è Aqu√≠ Nom√°s ‚Äî demo (1 input)</h1>

  <div class="box">
    <div class="row">
     <input id="qall" class="input" autofocus placeholder="Contame qu√© necesit√°s (ej: 'hola, estoy en almagro y busco resma A4')" />
      <button id="micBtn" class="btn mic" title="Dictar por voz (Chrome/Edge)">üé§</button>
      <button id="goBtn" class="btn">Buscar</button>
      <button id="clearBtn" class="btn ghost">Limpiar</button>
      <button id="cpyBtn" class="btn secondary">Copiar link</button>
      <button id="dbgBtn" class="btn secondary">üß™ Debug</button>
    </div>
    <div class="chips" id="chips"></div>
    <div class="tiny" style="margin-top:8px">Ejemplo: <em>‚Äúhola, estoy en villa devoto y necesito clavos‚Äù</em> o <em>‚Äúresma a4 en almagro‚Äù</em>. Enter tambi√©n busca.</div>
  </div>

  <div id="results" class="box"></div>
  <pre id="debug" class="debug"></pre>
</div>

<script>
// === PEG√Å AC√Å TU LINK PUBLICADO (Google Sheets ‚Üí ‚ÄúPublicar en la web‚Äù, termina en output=csv)
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTsfhmidUT4vOSY5u0TCi_7IlrpRcYi29_VF2-qgQniySHAfG18eNYoyvQ_Bqf0iB6nZaOaSXGBqUXP/pub?gid=0&single=true&output=csv"
// ===============================================================================

// Stopwords / muletillas
const STOP = new Set(["hola","buenas","buenos","dias","tardes","noches","necesito","quiero","busco","busca","buscar","buscando","buscaba","comprar","venta","un","una","de","para","con","el","la","los","las","en","por","y","o","a","al","del","estoy","estamos","aca","aqui","ahora","cerca","porfavor","porfa"]);

// Sin√≥nimos ‚Üí rubro
const RUBRO = {"resma":"Librer√≠a","papel":"Librer√≠a","hojas":"Librer√≠a","a4":"Librer√≠a","libreria":"Librer√≠a","libros":"Librer√≠a","clavo":"Ferreter√≠a","clavos":"Ferreter√≠a","tornillo":"Ferreter√≠a","tornillos":"Ferreter√≠a","destornillador":"Ferreter√≠a","mecha":"Ferreter√≠a","ferreteria":"Ferreter√≠a","flor":"Florer√≠a","flores":"Florer√≠a","floreria":"Florer√≠a","ramos":"Florer√≠a"};

const norm = s => (s||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
function toks(s){ return norm(s).replace(/[^\p{L}\p{N}\s]/gu," ").split(/\s+/).filter(t=>t && !STOP.has(t)); }
function parseCSV(txt){
  const rows = txt.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));
  const head = rows.shift().map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
  return rows.map(r=>Object.fromEntries(head.map((h,i)=>[h,(r[i]||"").trim()])));
}

// Analiza UNA frase y devuelve {q,z}
function understand(raw){
  const t0 = (raw||"").trim();
  const t = norm(t0);

  // primero "estoy en <zona...>"
  let m = t.match(/estoy\s+en\s+(.+?)(?=\s+(?:busc\w*|necesit\w*|quiero)\b|[,.!?]|$)/i);
  // o "en|por|de <zona...>"
  if(!m) m = t.match(/(?:^|\s)(?:en|por|de)\s+(.+?)(?=\s+(?:busc\w*|necesit\w*|quiero)\b|[,.!?]|$)/i);

  let zona = "", qText = t0;
  if(m){
    zona = m[1].trim().split(/\s+/).slice(0,4).join(" ");
    qText = t0.replace(new RegExp(m[0], 'i'), '').trim();
  }

  // limpieza de muletillas al inicio, y ‚Äúde ‚Ä¶‚Äù inicial
  qText = qText
    .replace(/^(?:hola|buenas|buenos dias|buenas tardes|buenas noches)\b[\s,]*/i,"")
    .replace(/^(?:estoy|estamos)\b[\s,]*/i,"")
    .replace(/^(?:busc\w*|necesit\w*|quiero)\b[\s,]*/i,"")
    .replace(/^de\s+/i,"")
    .trim();

  return { q:qText, z:zona };
}

let DATA=[], DEBUG=false;

// Carga CSV y estado inicial (?t=)
fetch(CSV_URL).then(r=>r.text()).then(t=>{
  DATA = parseCSV(t);
  const u = new URL(location.href);
  const t0 = u.searchParams.get('t') || localStorage.getItem('t') || '';
  if(t0){ document.getElementById('qall').value = t0; buscar(); }
}).catch(()=>{
  document.getElementById('results').innerHTML = '<div class="empty">No pude leer la hoja. Verific√° que el CSV est√© publicado y termine en <code>output=csv</code>.</div>';
});

// Botones
document.getElementById('goBtn').addEventListener('click', buscar);
document.getElementById('clearBtn').addEventListener('click', limpiar);
document.getElementById('dbgBtn').addEventListener('click', ()=>{
  DEBUG=!DEBUG;
  document.getElementById('debug').style.display = DEBUG?'block':'none';
  if(DEBUG) buscar();
});
document.getElementById('cpyBtn').addEventListener('click', ()=>{
  const inp = document.getElementById('qall').value.trim();
  const u = new URL(location.href);
  if(inp) u.searchParams.set('t', inp); else u.searchParams.delete('t');
  navigator.clipboard.writeText(u.toString()).then(()=>alert('Link copiado'));
});

// ENTER para buscar
document.getElementById('qall').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ e.preventDefault(); buscar(); }
});

// Buscar (desde 1 input)
function buscar(){
  const raw = document.getElementById('qall').value;
  localStorage.setItem('t', raw);
  const {q,z} = understand(raw);

  // Chips de lo que entendimos
  const chips = document.getElementById('chips');
  chips.innerHTML = [
    z ? `<div class="chip"><strong>Zona:</strong> ${z}</div>` : '',
    q ? `<div class="chip"><strong>Intenci√≥n:</strong> ${q}</div>` : ''
  ].join('');

  const out = buscarInterno(q, z);
  render(out);

  if(DEBUG){
    const qt = toks(q);
    const dbg = [`RAW: ${raw}`,`Q: ${q}`,`Z: ${z}`,`TOKENS: ${JSON.stringify(qt)}`].join('\n');
    document.getElementById('debug').textContent = dbg;
  }
}

function buscarInterno(q, z){
  const qt = toks(q), zt = norm(z);
  let rubroDetectado = ""; for(const t of qt){ if(RUBRO[t]){rubroDetectado=RUBRO[t];break;} }

  return DATA.map(l=>{
      const rub = norm(l.rubro);
      const blob = norm(`${l.rubro} ${l.keywords} ${l.tags||""}`); // "tags" opcional (autores, marcas)
      const bar  = norm(l.barrio);
      let score = 0;
      if(qt.length===0) score = 1; else qt.forEach(t=>{ if(blob.includes(t)) score++; });
      if(score===0 && rubroDetectado && rub.includes(norm(rubroDetectado))) score = 1;
      if(zt && !bar.includes(zt)) score = -1;
      return { l, score, bar };
    })
    .filter(x=>x.score>0)
    .sort((a,b)=>b.score-a.score)
    .slice(0,5)
    .map(x=>x.l);
}

function render(items){
  const box = document.getElementById('results');
  if(!items.length){ box.innerHTML = '<div class="empty">No encontr√© opciones. Prob√° con otra palabra o revis√° la zona en la frase.</div>'; return; }
  box.innerHTML = items.map(r=>{
    const wa   = "https://wa.me/54" + (r.whatsapp||"").replace(/[^0-9]/g,"");
    const maps = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(`${r.direccion||''} ${r.barrio||''}`);
    return `
      <div class="card">
        <div class="title">${r.nombre_local} ‚Äî <span>${r.rubro}</span></div>
        <div>${r.direccion} (${r.barrio})</div>
        <div>Horario: ${r.horario||"-"}</div>
        <div class="promo">${r.promo_texto ? "Promo: "+r.promo_texto : ""}</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <a class="btn" target="_blank" href="${wa}">WhatsApp</a>
          <a class="btn secondary" target="_blank" href="${maps}">C√≥mo llegar</a>
        </div>
      </div>`;
  }).join("");
}

// Limpiar todo
function limpiar(){
  const inp = document.getElementById('qall');
  inp.value = '';
  document.getElementById('chips').innerHTML = '';
  const d = document.getElementById('debug');
  d.style.display = 'none';
  d.textContent = '';
  DEBUG = false;
  localStorage.removeItem('t');
  render([]);
}

// === Micr√≥fono m√≠nimo (Chrome/Edge). Si no hay soporte, deshabilita el bot√≥n. ===
(function(){
  const btn = document.getElementById('micBtn');
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ btn.disabled=true; btn.innerText='üé§‚Äî'; btn.title='Dictado no disponible en este navegador.'; return; }
  const rec = new SR(); rec.lang='es-AR'; rec.interimResults=false; rec.maxAlternatives=1;
  btn.addEventListener('click', ()=>{
    try{ rec.start(); btn.innerText='‚è∫Ô∏è'; }catch(e){ /* ya escuchando */ }
  });
  rec.onresult = (e)=>{ const t=e.results[0][0].transcript||''; document.getElementById('qall').value=t.trim(); buscar(); };
  rec.onend = ()=>{ btn.innerText='üé§'; };
  rec.onerror = ()=>{ btn.innerText='üé§'; };
})();
</script>
</body>
</html>

