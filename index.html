<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aqu√≠ Nom√°s ‚Äî diagn√≥stico</title>
<style>
:root{--pri:#0b5cff;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#0b1220}
.wrap{max-width:1100px;margin:0 auto;padding:18px;display:grid;grid-template-columns:1fr 360px;gap:16px}
h1{font-size:20px;margin:0 0 14px}
.box{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:14px;margin:0 0 14px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.input{flex:1;min-width:260px;padding:12px 14px;border:1px solid #cfd6e0;border-radius:12px;font-size:15px}
.btn{padding:12px 14px;border-radius:12px;border:1px solid var(--pri);background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
.btn.secondary{background:#fff;color:var(--pri)}
.btn.ghost{background:#fff;border-color:#cfd6e0;color:#0b1220}
.btn.mic{border:1px dashed var(--pri);background:#eef3ff}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{background:#eef3ff;border:1px solid #d7e3ff;color:#153a9b;padding:6px 10px;border-radius:999px;font-size:12px}
.chip strong{font-weight:700;margin-right:4px}
.tiny{font-size:12px;color:#667}
.card{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:12px;margin:10px 0}
.title{font-weight:700;margin-bottom:4px}
.title span{font-weight:600;color:#555}
.promo{margin:6px 0 10px;color:#0b5cff}
.meta{font-size:12px;color:#566}
.empty{padding:12px;color:#666}
.err{padding:12px;background:#fff3f3;border:1px solid #ffd2d2;color:#7a1a1a;border-radius:12px}
#debugPanel{position:sticky;top:18px;height:calc(100vh - 36px);overflow:auto;background:#0b1220;color:#e8eef9;border-radius:14px;padding:12px;box-shadow:inset 0 0 0 1px #263249}
#debugPanel h2{margin:6px 0 10px;font-size:16px}
pre{white-space:pre-wrap;word-wrap:break-word;background:#0f1625;border:1px solid #263249;border-radius:10px;padding:8px;color:#cfe3ff;font-size:12px}
.kv{font-size:12px;line-height:1.4}
.kv b{color:#9ec1ff}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;font-size:11px;border:1px solid #415a9a;background:#16213b;color:#cfe3ff;margin-right:4px}
.ok{color:#6be38e} .warn{color:#ffd66b} .err2{color:#ff8b8b}
</style>
</head>
<body>
<div class="wrap">
  <div>
    <h1>üè∑Ô∏è Aqu√≠ Nom√°s ‚Äî diagn√≥stico</h1>
    <div class="box">
      <div class="row">
        <input id="qall" class="input" autofocus placeholder="Ej: 'cerca', 'Corrientes y 9 de Julio', 'comiditas'"/>
        <button id="goBtn" class="btn">Buscar</button>
        <button id="clearBtn" class="btn ghost">Limpiar</button>
        <button id="locBtn" class="btn secondary" title="Usar mi ubicaci√≥n">üìç Cerca</button>
      </div>
      <div class="chips" id="chips"></div>
      <div class="tiny" id="gpsHint" style="margin-top:6px;display:none">
        üìç Mostrando locales ‚â§ <span id="nearKm">1.5</span> km (auto-expande a 2 y 3 km si hace falta).
      </div>
      <div class="tiny" id="srcHint" style="margin-top:6px;display:none"></div>
    </div>
    <div id="error" style="display:none" class="box err"></div>
    <div id="results" class="box"></div>
  </div>

  <div id="debugPanel" class="box">
    <h2>üîß Debug</h2>
    <div class="kv">
      <div><b>CSV_URL:</b> <span id="dbgCsv"></span></div>
      <div><b>debug:</b> <span id="dbgDebug"></span> ¬∑ <b>demo:</b> <span id="dbgDemo"></span></div>
      <div><b>Filas CSV:</b> <span id="dbgRows">-</span></div>
      <div><b>Columnas detectadas:</b> <span id="dbgCols">-</span></div>
      <div><span class="badge">q</span><span id="dbgQ"></span></div>
      <div><span class="badge">z</span><span id="dbgZ"></span></div>
      <div><span class="badge">tokens</span><span id="dbgTok"></span></div>
      <div><span class="badge">modo</span><span id="dbgMode"></span></div>
      <div><span class="badge">resultado</span><span id="dbgRes"></span></div>
    </div>
    <h2>Primer registro</h2>
    <pre id="dbgFirst">-</pre>
    <h2>Motivos de descarte</h2>
    <pre id="dbgWhy">-</pre>
  </div>
</div>

<script>
// ====== params ======
function getParams(){
  const q = new URLSearchParams(location.search);
  const hash = new URLSearchParams(location.hash.replace(/^#/, ""));
  return {
    csv: (q.get("csv") || hash.get("csv") || "").trim(),
    debug: q.get("debug")==='1' || hash.get("debug")==='1',
    demo: q.get("demo")==='1' || hash.get("demo")==='1'
  };
}
const P = getParams();

// ====== CSV (defecto + ?csv= o demo) ======
const DEFAULT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg0UeYMVZj0b9H2V63XS37oXlIwJ6SL4n-m6WJEbspzM5OP9QA3QF6qSw4fr81dw/pub?gid=1861393565&single=true&output=csv";
function effectiveCSV(){
  if(P.demo) return "__DEMO__";
  return (P.csv || DEFAULT_CSV);
}
const CSV_URL = (()=>{
  const base = effectiveCSV();
  if(base==="__DEMO__") return base;
  const sep = base.includes("?") ? "&" : "?";
  return base + sep + "v=" + Date.now();
})();
// =====================

// utils sin \p{...}
function removeDiacritics(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
const STOP = new Set(["hola","buenas","buenos","dias","tardes","noches","necesito","quiero","busco","buscar","comprar","un","una","unos","unas","de","para","con","el","la","los","las","en","por","y","o","a","al","del","estoy","aca","aqui","ahora","porfavor","porfa","avenida","av","sobre","calle","cerca"]);
const norm = s => removeDiacritics(String(s||"").toLowerCase()).replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();
function stem(t){ return t.replace(/(es|s)$/,""); }

const SYN = {
  "gastronomia":["comida","comidita","comiditas","almuerzo","almorzar","resto","restaurante","bar","cafeteria","bebida","vianda"],
  "libreria":["libreria","libro","libros","papeleria","resma","a4","cuaderno","lapiz","lapices","pluma","fibron","resmas"],
  "ferreteria":["ferreteria","ferretria","tornillo","tornillos","clavo","clavos","herramienta","herramientas","chapa","chapas","bulon","bulones"]
};

function aliasPlace(s){
  let t=norm(s);
  t=t.replace(/\bnueva?\b\s+de\s+julio/g,"9 de julio");
  t=t.replace(/\bnueve\s+de\s+julio/g,"9 de julio");
  t=t.replace(/\b9\s*julio\b/g,"9 de julio");
  t=t.replace(/\bcorrs?entes\b/g,"corrientes");
  t=t.replace(/\bcerritto\b/g,"cerrito");
  t=t.replace(/\bsanta\s*fe\b/g,"santa fe");
  t=t.replace(/\bel\s*centro\b/g,"microcentro");
  return t;
}

function toks(s){
  const base = norm(s).split(/\s+/).filter(t=>t&&!STOP.has(t));
  const out = new Set();
  base.forEach(t=>{
    out.add(t); out.add(stem(t));
    Object.entries(SYN).forEach(([k,arr])=>{ if(arr.includes(t) || arr.includes(stem(t))) out.add(k); });
  });
  return Array.from(out).filter(Boolean);
}

function parseCSV(txt){
  const rows=txt.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));
  const head=rows.shift().map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
  return {head, rows: rows.map(r=>Object.fromEntries(head.map((h,i)=>[h,(r[i]||"").trim()]))) };
}

function parseCoord(v){
  if(v==null||v==="") return NaN;
  let s=String(v).trim();
  const isNeg = /^\s*-/.test(s);
  s=s.replace(/,/g,'.');
  const parts = s.split('.');
  if(parts.length>2) s = parts[0]+'.'+parts.slice(1).join('');
  let n = Number(s);
  if(Number.isNaN(n)){ const digits = s.replace(/[^0-9]/g,''); if(digits.length>=7){ n=parseInt(digits,10)/1e6; if(isNeg) n=-Math.abs(n); } }
  if(Math.abs(n)>180) n/=1e6;
  return n;
}

function haversineKm(a,b){
  const R=6371,toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat),dLng=toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);
  const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.min(1,Math.sqrt(A)));
}

// estado
let USER_POS=null, NEAR_ACTIVE=false;
let NEAR_RADIUS_KM=1.5;
let DATA=[], IDX=[], LOADED=false, WHY=[];

// demo inline (para aislar CSV)
const DEMO = `nombre_local,rubro,keywords,direccion,barrio,lat,lng,horario,promo_texto
Comiditas,gastronomia,almuerzo,Av. Corrientes y 9 de Julio,Microcentro,-34.6037,-58.3816,,Men√∫ del d√≠a
Libreria Centro,libreria,libros cuadernos,Av. Santa Fe 900,Recoleta,-34.595,-58.39,,20% en √∫tiles
Ferre Todo,ferreteria,tornillos clavos,Bolivar 500,San Telmo,-34.617,-58.369,,Atendemos domingo`;

// init
document.getElementById('dbgCsv').textContent = (CSV_URL==="__DEMO__"? "(demo interno)" : CSV_URL);
document.getElementById('dbgDebug').textContent = P.debug? "on":"off";
document.getElementById('dbgDemo').textContent = P.demo? "on":"off";

function logWhy(msg){ WHY.push(msg); }

function loadData(){
  if(CSV_URL==="__DEMO__"){
    const parsed = parseCSV(DEMO);
    hydrate(parsed);
    return;
  }
  fetch(CSV_URL,{cache:"no-store"})
    .then(r=>{ if(!r.ok) throw new Error("HTTP "+r.status); return r.text(); })
    .then(t=>{ hydrate(parseCSV(t)); })
    .catch(e=>{ const err=document.getElementById('error'); err.style.display='block'; err.innerHTML="No pude cargar la base (CSV).<div style='margin-top:6px;font-size:12px;color:#666'>Detalle: "+(e.message||e)+"</div>"; });
}

function hydrate(parsed){
  const {head, rows} = parsed;
  document.getElementById('dbgCols').textContent = head.join(", ");
  document.getElementById('dbgRows').textContent = rows.length;
  DATA = rows;
  IDX = DATA.map(row=>{
    const promo = row.promo_texto || row["promo_texto "] || row["promo_texto_"] || "";
    const nombreRaw = row.nombre_local||row.nombre||row.local||"";
    const nombre=norm(nombreRaw);
    const rubro=norm(row.rubro||"");
    let kw=norm(row.keywords||"");
    let kwExp = kw + " " + nombre;
    Object.entries(SYN).forEach(([k,arr])=>{ if(rubro.includes(k) || arr.some(a=>kw.includes(a))) kwExp += " " + k + " " + arr.join(" "); });
    const dirbar=aliasPlace((row.direccion||"")+" "+(row.barrio||"")).replace(/,+/g," ").replace(/\s+/g," ").trim();
    const lat=parseCoord(row.lat), lng=parseCoord(row.lng);
    return {nombre,rubro,kw:norm(kwExp),dirbar,lat,lng,promo_raw:promo,_row:row};
  });
  LOADED=true;
  document.getElementById('dbgFirst').textContent = rows[0]? JSON.stringify(rows[0],null,2): "-";
  showSrcHint();
}

function showSrcHint(){
  const el=document.getElementById('srcHint');
  el.style.display='block';
  el.textContent = "Fuente: " + (CSV_URL==="__DEMO__" ? "(demo interno)" : (new URL(CSV_URL)).origin + (new URL(CSV_URL)).pathname);
}

function understand(raw){
  const t0=(raw||"").trim();
  const t=aliasPlace(t0);
  let zona="", qText=t0, wantsNear=/\bcerca\b/.test(t);

  const intRegex = /(.*?)[\s]*([a-z0-9\s]+\s*(?:y|&|\/)\s*[a-z0-9\s]+)$/i;
  let m=t.match(intRegex);
  if(m && m[2]){ zona=(m[2]||"").trim(); qText=(m[1]||"").trim(); }

  if(!zona){
    m=t.match(/(?:estoy|vivo|me\s+encuentro)?\s*(?:en|por|sobre)\s+([a-z0-9\s]+)$/i);
    if(m){ zona=(m[1]||"").trim(); qText=t0.replace(new RegExp(m[0],'i'),'').trim(); }
    else{ const words=t.split(/\s+/).filter(Boolean); if(words.length>0&&(words.length<=4||t.includes(" y "))) { zona=t0.trim(); qText=""; } }
  }
  return { q:qText, z:zona, wantsNear };
}

function locationMatch(idx,zona){
  if(!zona) return true;
  const f=IDX[idx].dirbar;
  const zn=aliasPlace(zona);
  if(/\b(y|&|\/)\b/.test(zn)){ const parts=zn.split(/\b(?:y|&|\/)\b/).map(x=>norm(x).trim()).filter(Boolean); if(parts.length===2){ const [a,b]=parts; const ok=(f.includes(a) && f.includes(b)); if(!ok && P.debug) logWhy("No intersecci√≥n: '"+a+"' y '"+b+"' no aparecen juntos en dirbar => "+f); return ok; } }
  const zWords=norm(zn).split(/\s+/).filter(Boolean);
  if(zWords.some(w=>f.includes(w))) return true;
  for(let i=0;i<zWords.length-1;i++){ const bi=zWords[i]+" "+zWords[i+1]; if(f.includes(bi)) return true; }
  const ok=f.includes(norm(zn)); if(!ok && P.debug) logWhy("Zona no matchea en dirbar => "+f);
  return ok;
}

function scoreRow(M, qt, qnorm) {
  let score=0;
  if(qnorm && M.nombre===qnorm) score+=12;
  if(qnorm && M.nombre.includes(qnorm)) score+=8;
  qt.forEach(t=>{ if(M.nombre.includes(t)) score+=4; if(M.kw.includes(t)) score+=3; if(M.rubro.includes(t)) score+=2; });
  return score;
}

// UI
document.getElementById('goBtn').addEventListener('click',buscar);
document.getElementById('clearBtn').addEventListener('click',()=>{
  document.getElementById('qall').value="";
  document.getElementById('results').innerHTML="";
  document.getElementById('chips').innerHTML="";
  WHY=[]; document.getElementById('dbgWhy').textContent="-";
  NEAR_ACTIVE=false; document.getElementById('gpsHint').style.display='none';
  document.getElementById('error').style.display='none';
  document.getElementById('dbgTok').textContent="";
  document.getElementById('dbgQ').textContent="";
  document.getElementById('dbgZ').textContent="";
  document.getElementById('dbgRes').textContent="";
});
document.getElementById('qall').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); buscar(); } });
document.getElementById('locBtn').addEventListener('click',()=>{
  USER_POS={lat:-34.6037,lng:-58.3816};
  NEAR_ACTIVE=true;
  document.getElementById('nearKm').textContent=NEAR_RADIUS_KM.toFixed(1);
  document.getElementById('gpsHint').style.display='block';
  buscar();
});

function buscar(){
  if(!LOADED){ alert("Cargando datos‚Ä¶"); return; }
  WHY=[];
  const raw=document.getElementById('qall').value;
  let {q,z,wantsNear}=understand(raw);
  document.getElementById('dbgQ').textContent=q;
  document.getElementById('dbgZ').textContent=z;
  document.getElementById('dbgMode').textContent = NEAR_ACTIVE? "cercanos":"texto";
  const tok = toks(q); document.getElementById('dbgTok').textContent=tok.join(" ");
  if(wantsNear || NEAR_ACTIVE){ if(!USER_POS) USER_POS={lat:-34.6037,lng:-58.3816}; NEAR_ACTIVE=true; z=""; document.getElementById('gpsHint').style.display='block'; }
  document.getElementById('chips').innerHTML=[
    z?`<div class="chip"><strong>Zona:</strong> ${z}</div>`:'',
    q?`<div class="chip"><strong>Intenci√≥n:</strong> ${q}</div>`:'',
    (NEAR_ACTIVE&&USER_POS)?`<div class="chip"><strong>Modo:</strong> cercanos</div>`:''
  ].join('');
  const items=buscarInterno(q,z);
  document.getElementById('dbgRes').textContent = items.length+" item(s)";
  if(P.debug) document.getElementById('dbgWhy').textContent = WHY.length? WHY.join("\n") : "(sin descartes)";
  render(items,q,z);
}

function buscarInterno(q,z){
  const qnorm=norm(q);
  const qt=toks(q);

  if(NEAR_ACTIVE && USER_POS){
    const withDist = DATA.map((row,idx)=>{ const M=IDX[idx]; if(!Number.isFinite(M.lat)||!Number.isFinite(M.lng)) return null; const d=haversineKm(USER_POS,{lat:M.lat,lng:M.lng}); return {...row,_distKm:d,_idx:idx}; }).filter(Boolean).sort((a,b)=>a._distKm-b._distKm);
    let radius=NEAR_RADIUS_KM; let inside = withDist.filter(r=>r._distKm<=radius);
    if(inside.length<2){ radius=2.0; inside = withDist.filter(r=>r._distKm<=radius); }
    if(inside.length<2){ radius=3.0; inside = withDist.filter(r=>r._distKm<=radius); }
    document.getElementById('nearKm').textContent=radius.toFixed(1);
    return inside.slice(0,20);
  }

  let arr = DATA.map((row,idx)=>{ const M=IDX[idx]; let score=scoreRow(M, qt, qnorm); if(z && !locationMatch(idx,z)) score=-1; let distKm=null; if(score>=0 && USER_POS && Number.isFinite(M.lat) && Number.isFinite(M.lng)){ distKm=haversineKm(USER_POS,{lat:M.lat,lng:M.lng}); score+=Math.max(0,2-(distKm/1.5)); } if(score<=0){ if(P.debug) logWhy("Descartado por score<=0 ‚Äî nombre:'"+M.nombre+"' rubro:'"+M.rubro+"' kw:'"+M.kw+"'"); } return score>0? { l:{...row,_distKm:distKm,_idx:idx}, score, M } : null; }).filter(Boolean);

  if(arr.length===0 && qnorm){
    const qtok = qnorm.split(/\s+/).filter(Boolean);
    arr = DATA.map((row,idx)=>{ const M=IDX[idx]; const hay = qtok.some(t=> M.nombre.includes(t) || M.rubro.includes(t) || M.kw.includes(t)); if(!hay){ if(P.debug) logWhy("Fallback: tampoco hay substring en idx "+idx); return null; } return { l:{...row,_distKm:null,_idx:idx}, score:1, M }; }).filter(Boolean);
  }

  return arr.sort((a,b)=>b.score-a.score).slice(0,30).map(x=>x.l);
}

function render(items,q,z){
  const box=document.getElementById('results');
  if(!items.length){ box.innerHTML='<div class="empty">No encontr√© opciones.</div>'; return; }
  box.innerHTML=items.map(r=>{ const name=r.nombre_local||r.nombre||r.local||'(sin nombre)'; const maps=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((r.direccion||"")+" "+(r.barrio||""))}`; const wa=r.whatsapp?("https://wa.me/54"+String(r.whatsapp).replace(/[^0-9]/g,"")):null; const dist=(typeof r._distKm==='number')?`<div class="meta">‚âà ${(r._distKm*10).toFixed(0)} cuadras</div>`:''; const promo=IDX[r._idx]?IDX[r._idx].promo_raw:"";
    return `<div class="card">
      <div class="title">${name} ‚Äî <span>${r.rubro||''}</span></div>
      <div>${r.direccion||''} ${r.barrio?`(${r.barrio})`:''}</div>
      ${r.horario?`<div class="promo">Horario: ${r.horario}</div>`:''}
      ${promo?`<div class="promo">${promo}</div>`:''}
      ${dist}
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
        ${wa?`<a class="btn" target="_blank" href="${wa}">WhatsApp</a>`:''}
        <a class="btn secondary" target="_blank" href="${maps}">C√≥mo llegar</a>
      </div>
    </div>`; }).join("");
}

// start
loadData();
</script>
</body>
</html>
