<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aqu√≠ Nom√°s ‚Äî Demo (Pack A: intersecciones + cerca + fuzzy)</title>
<style>
:root{--pri:#0b5cff;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#0b1220}
.wrap{max-width:860px;margin:0 auto;padding:18px}
h1{font-size:20px;margin:0 0 14px}
.box{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:14px;margin:0 0 14px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.input{flex:1;min-width:260px;padding:12px 14px;border:1px solid #cfd6e0;border-radius:12px;font-size:15px}
.btn{padding:12px 14px;border-radius:12px;border:1px solid var(--pri);background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
.btn.secondary{background:#fff;color:var(--pri)}
.btn.ghost{background:#fff;border-color:#cfd6e0;color:#0b1220}
.btn.mic{border:1px dashed var(--pri);background:#eef3ff}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{background:#eef3ff;border:1px solid #d7e3ff;color:#153a9b;padding:6px 10px;border-radius:999px;font-size:12px}
.chip strong{font-weight:700;margin-right:4px}
.tiny{font-size:12px;color:#667}
.card{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:12px;margin:10px 0}
.title{font-weight:700;margin-bottom:4px}
.title span{font-weight:600;color:#555}
.promo{margin:6px 0 10px;color:var(--pri)}
.empty{padding:12px;color:#666}
</style>
</head>
<body>
<div class="wrap">
<h1>üè∑Ô∏è Aqu√≠ Nom√°s ‚Äî demo (intersecciones + cerca + fuzzy)</h1>

<div class="box">
  <div class="row">
    <input id="qall" class="input" autofocus placeholder="Ej: 'estoy en Devoto y necesito clavos', 'almorzar en el centro', 'ferreter√≠a en cabildo y juramento', 'flores cerca de Almagro'"/>
    <button id="micBtn" class="btn mic" title="Dictar por voz (Chrome/Edge)">üé§</button>
    <button id="goBtn" class="btn">Buscar</button>
    <button id="clearBtn" class="btn ghost">Limpiar</button>
    <button id="cpyBtn" class="btn secondary">Copiar link</button>
  </div>
  <div class="chips" id="chips"></div>
  <div class="tiny" style="margin-top:8px">Enter tambi√©n busca. El orden de la frase no importa.</div>
</div>

<div id="results" class="box"></div>
</div>

<script>
// === peg√° ac√° tu link de google sheets publicado ===
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTsfhmidUT4vOSY5u0TCi_7IlrpRcYi29_VF2-qgQniySHAfG18eNYoyvQ_Bqf0iB6nZaOaSXGBqUXP/pub?gid=0&single=true&output=csv";
// ===============================================

const STOP = new Set(["hola","buenas","buenos","dias","tardes","noches","necesito","quiero","busco","busca","buscar","buscando","buscaba","comprar","venta","un","una","de","para","con","el","la","los","las","en","por","y","o","a","al","del","estoy","estamos","aca","aqui","ahora","cerca","porfavor","porfa"]);
const norm = s => (s||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
function toks(s){ return norm(s).replace(/[^\p{L}\p{N}\s]/gu," ").split(/\s+/).filter(t=>t && !STOP.has(t)); }

function parseCSV(txt){
  const rows = txt.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));
  const head = rows.shift().map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
  return rows.map(r=>Object.fromEntries(head.map((h,i)=>[h,(r[i]||"").trim()])));
}

// ‚Äî‚Äî‚Äî fuzzy matching b√°sico (distancia de edici√≥n ‚â§ 1) ‚Äî‚Äî‚Äî
function editDist1(a,b){
  if(a===b) return 0;
  const la=a.length, lb=b.length;
  if(Math.abs(la-lb)>1) return 2; // m√°s de 1 diff
  // sustituir
  if(la===lb){
    let dif=0; for(let i=0;i<la;i++){ if(a[i]!==b[i]){ if(++dif>1) return 2; } }
    return dif;
  }
  // insertar/eliminar
  let i=0,j=0,dif=0;
  while(i<la && j<lb){
    if(a[i]===b[j]){i++;j++;continue;}
    dif++; if(dif>1) return 2;
    if(la>lb) i++; else j++;
  }
  // resto
  if(i<la || j<lb) dif++;
  return dif;
}
function approxTokenMatch(a,b){ // a contra b
  if(!a||!b) return false;
  if(b.includes(a) || a.includes(b)) return true;
  return editDist1(a,b) <= 1;
}

// ‚Äî‚Äî interpretador de frases (zona + intenci√≥n) ‚Äî‚Äî 
function understand(raw){
  const t0 = (raw||"").trim();
  const t  = norm(t0);
  let zona="", qText=t0;

  // ‚Äúestoy en devoto (y) necesito/clavos‚Ä¶‚Äù
  let m = t.match(/(?:estoy|vivo|me\s+encuentro)\s+en\s+([a-z√°√©√≠√≥√∫√±\s]+?)(?=\s*(?:y\s+)?(?:busc\w*|necesit\w*|quiero|ir|comer|almorzar|cenar)\b|[,.!?]|$)/i);
  // ‚Äúen|por|de devoto necesito/quiero‚Ä¶‚Äù
  if(!m) m = t.match(/(?:^|\s)(?:en|por|de)\s+([a-z√°√©√≠√≥√∫√±\s]+?)(?=\s+(?:busc\w*|necesit\w*|quiero|ir|comer|almorzar|cenar)\b|[,.!?]|$)/i);
  // ‚Äúalmorzar en devoto‚Äù
  if(!m) m = t.match(/(?:almorzar|cenar|comer|buscar|ir|comprar|necesito|quiero)\s+(?:algo\s+)?en\s+([a-z√°√©√≠√≥√∫√±\s]+)$/i);
  // ‚Äúcerca de almagro‚Äù
  if(!m) m = t.match(/cerca\s+de\s+([a-z√°√©√≠√≥√∫√±\s]+)$/i);
  // ‚Äúcabildo y juramento‚Äù, ‚Äúesquina cabildo y juramento‚Äù
  if(!m) m = t.match(/(?:esquina\s+)?([a-z√°√©√≠√≥√∫√±\s]+)\s+y\s+([a-z√°√©√≠√≥√∫√±\s]+)$/i);

  if(m){
    if(m.length>=3 && m[2]){ zona = (m[1]+" "+m[2]).trim(); }
    else { zona = (m[1]||"").trim(); }
    // recortar a 4 palabras
    zona = zona.split(/\s+/).slice(0,4).join(" ");
    qText = t0.replace(new RegExp(m[0],'i'), '').trim();
  }

  // limpiar muletillas al inicio de la intenci√≥n
  qText = qText
    .replace(/^(?:hola|buenas|buenos dias|buenas tardes|buenas noches)\b[\s,]*/i,"")
    .replace(/^(?:estoy|estamos|vivo|me\s+encuentro)\b[\s,]*/i,"")
    .replace(/^(?:busc\w*|necesit\w*|quiero|ir|comer|almorzar|cenar)\b[\s,]*/i,"")
    .replace(/^de\s+/i,"")
    .trim();

  return { q:qText, z:zona };
}

// ‚Äî‚Äî match de ubicaci√≥n (barrios y direcci√≥n, con fuzzy) ‚Äî‚Äî
function locationMatch(row, zona){
  if(!zona) return true;
  const zt = toks(zona);
  const tb = toks(row.barrio||"");
  const td = toks(row.direccion||"");
  for(const z of zt){
    // barrio tokens
    for(const b of tb){ if(approxTokenMatch(z,b)) return true; }
    // direcci√≥n tokens (calles, etc.)
    for(const d of td){ if(approxTokenMatch(z,d)) return true; }
  }
  // includes crudo como backup
  const nb = norm(row.barrio||""), nd = norm(row.direccion||""), nz = norm(zona);
  if(nb.includes(nz) || nd.includes(nz) || nz.includes(nb) || nz.includes(nd)) return true;
  return false;
}

let DATA = [];
fetch(CSV_URL).then(r=>r.text()).then(t=>{ DATA = parseCSV(t); });

document.getElementById('goBtn').addEventListener('click', buscar);
document.getElementById('clearBtn').addEventListener('click', limpiar);
document.getElementById('cpyBtn').addEventListener('click', ()=>{
  const inp = document.getElementById('qall').value.trim();
  const u = new URL(location.href);
  if(inp) u.searchParams.set('t', inp); else u.searchParams.delete('t');
  navigator.clipboard.writeText(u.toString()).then(()=>alert('Link copiado'));
});
document.getElementById('qall').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ e.preventDefault(); buscar(); }
});

function buscar(){
  const raw = document.getElementById('qall').value;
  const {q,z} = understand(raw);
  document.getElementById('chips').innerHTML = [
    z ? `<div class="chip"><strong>Zona:</strong> ${z}</div>` : '',
    q ? `<div class="chip"><strong>Intenci√≥n:</strong> ${q}</div>` : ''
  ].join('');
  render(buscarInterno(q,z));
}

function buscarInterno(q,z){
  const qt = toks(q);
  return DATA.map(l=>{
      const blob = norm(Object.values(l).join(" "));
      let score = 0;
      // score por intenci√≥n
      qt.forEach(t=>{
        if(blob.includes(t)) score += 1;
        else {
          // fuzzy: si alguna palabra del blob se parece mucho al token, suma medio punto
          const words = blob.split(/\s+/);
          for(const w of words){ if(approxTokenMatch(t,w)){ score += 0.5; break; } }
        }
      });
      // filtro de ubicaci√≥n (barrio o direcci√≥n)
      if(z && !locationMatch(l,z)) score = -1;
      return { l, score };
    })
    .filter(x=>x.score>0)
    .sort((a,b)=>b.score-a.score)
    .slice(0,8)
    .map(x=>x.l);
}

function render(items){
  const box = document.getElementById('results');
  if(!items.length){ box.innerHTML='<div class="empty">No encontr√© opciones. Prob√° con otra palabra o zona.</div>'; return; }
  box.innerHTML = items.map(r=>{
    const wa   = r.whatsapp ? ("https://wa.me/54"+String(r.whatsapp).replace(/[^0-9]/g,"")) : null;
    const maps = "https://www.google.com/maps/search/?api=1&query="+encodeURIComponent(`${r.direccion||''} ${r.barrio||''}`);
    return `
      <div class="card">
        <div class="title">${r.nombre_local||'(sin nombre)'} ‚Äî <span>${r.rubro||''}</span></div>
        <div>${r.direccion||''} ${r.barrio?`(${r.barrio})`:''}</div>
        ${r.horario?`<div>Horario: ${r.horario}</div>`:''}
        ${r.promo_texto?`<div class="promo">Promo: ${r.promo_texto}</div>`:''}
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          ${wa?`<a class="btn" target="_blank" href="${wa}">WhatsApp</a>`:''}
          <a class="btn secondary" target="_blank" href="${maps}">C√≥mo llegar</a>
        </div>
      </div>`;
  }).join("");
}

function limpiar(){
  document.getElementById('qall').value="";
  document.getElementById('chips').innerHTML="";
  document.getElementById('results').innerHTML="";
}

// micr√≥fono
(function(){
  const btn = document.getElementById('micBtn');
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ btn.disabled=true; btn.innerText='üé§‚Äî'; btn.title='Dictado no disponible.'; return; }
  const rec = new SR(); rec.lang='es-AR'; rec.interimResults=false; rec.maxAlternatives=1;
  btn.addEventListener('click', ()=>{ try{ rec.start(); btn.innerText='‚è∫Ô∏è'; }catch(e){} });
  rec.onresult = e => { const t=e.results[0][0].transcript||''; document.getElementById('qall').value=t.trim(); buscar(); };
  rec.onend    = ()=>{ btn.innerText='üé§'; };
  rec.onerror  = ()=>{ btn.innerText='üé§'; };
})();
</script>
</body>
</html>
















