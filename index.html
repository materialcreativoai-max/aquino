<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aqu√≠ Nom√°s ‚Äî FINAL</title>
<style>
:root{--pri:#0b5cff;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#0b1220}
.wrap{max-width:860px;margin:0 auto;padding:18px}
h1{font-size:20px;margin:0 0 14px}
.box{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:14px;margin:0 0 14px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.input{flex:1;min-width:260px;padding:12px 14px;border:1px solid #cfd6e0;border-radius:12px;font-size:15px}
.btn{padding:12px 14px;border-radius:12px;border:1px solid var(--pri);background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
.btn.secondary{background:#fff;color:var(--pri)}
.tiny{font-size:12px;color:#667}
.card{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:12px;margin:10px 0}
.title{font-weight:700;margin-bottom:4px}
.title span{font-weight:600;color:#555}
.meta{font-size:12px;color:#566}
.err{padding:12px;background:#fff3f3;border:1px solid #ffd2d2;color:#7a1a1a;border-radius:12px;margin-bottom:12px}
.ok{padding:10px 12px;background:#eef9f1;border:1px solid #cfead8;border-radius:10px;margin-bottom:12px;color:#145a32}
</style>
</head>
<body>
<div class="wrap">
  <h1>üè∑Ô∏è Aqu√≠ Nom√°s ‚Äî FINAL</h1>
  <div id="status" class="ok" style="display:none"></div>
  <div id="error" class="err" style="display:none"></div>

  <div class="box">
    <div class="row">
      <input id="q" class="input" autofocus placeholder="Ej: 'comiditas', 'libreria', 'Corrientes y 9 de Julio', 'Flores'"/>
      <button id="go" class="btn">Buscar</button>
      <button id="near" class="btn secondary">üìç Cerca</button>
    </div>
    <div class="tiny" id="gpsHint" style="margin-top:6px;display:none">
      üìç Mostrando ‚â§ <span id="nearKm">1.5</span> km.
    </div>
    <div class="tiny" id="srcHint" style="margin-top:6px;"></div>
  </div>

  <div id="results" class="box"></div>
</div>

<script>
// === CSV FIJO ===
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg0UeYMVZj0b9H2V63XS37oXlIwJ6SL4n-m6WJEbspzM5OP9QA3QF6qSw4fr81dw/pub?gid=1861393565&single=true&output=csv";
document.getElementById('srcHint').textContent = "Fuente CSV: " + CSV_URL;

// === utilidades ===
function removeDiacritics(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
const norm = s => removeDiacritics(String(s||"").toLowerCase()).replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();
function parseCSV(txt){
  const rows=txt.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));
  const head=rows.shift().map(h=>String(h).trim().toLowerCase().replace(/\s+/g,'_'));
  return rows.map(r=>Object.fromEntries(head.map((h,i)=>[h,(r[i]||"").trim()])));
}
function parseCoord(v){
  if(v==null||v==="") return NaN;
  let s=String(v).trim(); const isNeg = /^\s*-/.test(s);
  s=s.replace(/,/g,'.'); const parts = s.split('.');
  if(parts.length>2) s = parts[0]+'.'+parts.slice(1).join('');
  let n = Number(s);
  if(Number.isNaN(n)){ const digits = s.replace(/[^0-9]/g,''); if(digits.length>=7){ n=parseInt(digits,10)/1e6; if(isNeg) n=-Math.abs(n); } }
  if(Math.abs(n)>180) n/=1e6; return n;
}
function haversineKm(a,b){
  const R=6371,toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat),dLng=toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);
  const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.min(1,Math.sqrt(A)));
}

// === estado ===
let DATA=[], IDX=[], LOADED=false;
let USER_POS=null, NEAR=false, NEAR_KM=1.5;

// === fetch CSV con fallback a gviz ===
async function fetchCSV(){
  // intento 1: URL tal cual (ya tiene output=csv)
  const u1 = CSV_URL + (CSV_URL.includes("?")?"&":"?") + "v=" + Date.now();
  let r = await fetch(u1,{cache:"no-store"});
  let t = await r.text();
  let ct = r.headers.get("content-type")||"";
  if(!(ct.includes("text/html") || /^\s*<!doctype\s+html/i.test(t))) return t;

  // intento 2: gviz out:csv (por si Google devuelve HTML)
  try {
    const u = new URL(CSV_URL);
    u.pathname = u.pathname.replace(/\/pub$/, "/gviz/tq");
    u.searchParams.set("tqx","out:csv");
    u.searchParams.set("v", Date.now());
    r = await fetch(u.toString(), {cache:"no-store"});
    t = await r.text();
    ct = r.headers.get("content-type")||"";
    if(!(ct.includes("text/html") || /^\s*<!doctype\s+html/i.test(t))) return t;
  } catch(e) {}

  throw new Error("Google devolvi√≥ HTML en vez de CSV. Revis√° la publicaci√≥n de la hoja.");
}

fetchCSV()
 .then(t=>{
    DATA=parseCSV(t);
    IDX=DATA.map(row=>{
      const nombre=norm(row.nombre_local||row.nombre||row.local||"");
      const rubro=norm(row.rubro||"");
      const kw=norm((row.keywords||"") + " " + (row.nombre_local||row.nombre||row.local||""));
      const dirbar=norm((row.direccion||"")+" "+(row.barrio||""));
      const lat=parseCoord(row.lat), lng=parseCoord(row.lng);
      return {nombre,rubro,kw,dirbar,lat,lng};
    });
    LOADED=true;
    const ok=document.getElementById('status'); ok.style.display='block';
    ok.textContent="CSV cargado OK ¬∑ filas: "+DATA.length;
 })
 .catch(e=>{
    const el=document.getElementById('error'); el.style.display='block';
    el.textContent="No se pudo leer el CSV. "+(e.message||e);
 });

// === UI ===
document.getElementById('go').addEventListener('click',buscar);
document.getElementById('q').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();buscar();}});
document.getElementById('near').addEventListener('click',()=>{
  if(!navigator.geolocation){ USER_POS={lat:-34.6037,lng:-58.3816}; NEAR=true; buscar(); return; }
  navigator.geolocation.getCurrentPosition(p=>{ USER_POS={lat:p.coords.latitude,lng:p.coords.longitude}; NEAR=true; buscar(); },()=>{ USER_POS={lat:-34.6037,lng:-58.3816}; NEAR=true; buscar(); },{enableHighAccuracy:true,timeout:8000});
});

function buscar(){
  if(!LOADED){ alert("Esper√° que cargue el CSV‚Ä¶"); return; }
  const q = norm(document.getElementById('q').value);
  const toks = q.split(/\s+/).filter(Boolean);

  let items = DATA.map((row,idx)=>({ row,idx }));

  if(NEAR && USER_POS){
    document.getElementById('gpsHint').style.display='block';
    document.getElementById('nearKm').textContent=NEAR_KM.toFixed(1);
    items = items.map(o=>{
      const M=IDX[o.idx];
      if(!Number.isFinite(M.lat)||!Number.isFinite(M.lng)) return {...o,dist:Infinity};
      return {...o, dist:haversineKm(USER_POS,{lat:M.lat,lng:M.lng})};
    }).filter(o=>o.dist<=NEAR_KM).sort((a,b)=>a.dist-b.dist);
  } else if(q) {
    items = items.filter(o=>{
      const M=IDX[o.idx];
      // match si cada token aparece en alg√∫n campo textual
      const hay = toks.every(t=> M.nombre.includes(t) || M.rubro.includes(t) || M.kw.includes(t) || M.dirbar.includes(t) );
      return hay;
    });
  }

  render(items.slice(0,40));
}

function render(arr){
  const box=document.getElementById('results');
  if(!arr.length){ box.innerHTML='<div class="tiny">Sin resultados. Prob√° una palabra m√°s general.</div>'; return; }
  box.innerHTML = arr.map(o=>{
    const r=o.row, M=IDX[o.idx];
    const name=r.nombre_local||r.nombre||r.local||'(sin nombre)';
    const maps=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((r.direccion||"")+" "+(r.barrio||""))}`;
    const dist=(typeof o.dist==='number' && isFinite(o.dist))?('<div class="meta">‚âà '+(o.dist*10).toFixed(0)+' cuadras</div>'):'';
    return '<div class="card">'
      + '<div class="title">'+name+' ‚Äî <span>'+(r.rubro||'')+'</span></div>'
      + '<div>'+(r.direccion||'')+' '+(r.barrio?('('+(r.barrio)+')'):'')+'</div>'
      + dist
      + '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">'
      + '<a class="btn secondary" target="_blank" href="'+maps+'">C√≥mo llegar</a>'
      + '</div>'
      + '</div>';
  }).join("");
}
</script>
</body>
</html>
