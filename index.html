<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aqu√≠ Nom√°s ‚Äî demo estable (restaurada)</title>
<style>
:root{--pri:#0b5cff;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#0b1220}
.wrap{max-width:860px;margin:0 auto;padding:18px}
h1{font-size:20px;margin:0 0 14px}
.box{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:14px;margin:0 0 14px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.input{flex:1;min-width:260px;padding:12px 14px;border:1px solid #cfd6e0;border-radius:12px;font-size:15px}
.btn{padding:12px 14px;border-radius:12px;border:1px solid var(--pri);background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
.btn.secondary{background:#fff;color:var(--pri)}
.btn.ghost{background:#fff;border-color:#cfd6e0;color:#0b1220}
.btn.mic{border:1px dashed var(--pri);background:#eef3ff}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{background:#eef3ff;border:1px solid #d7e3ff;color:#153a9b;padding:6px 10px;border-radius:999px;font-size:12px}
.chip strong{font-weight:700;margin-right:4px}
.tiny{font-size:12px;color:#667}
.card{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:12px;margin:10px 0}
.title{font-weight:700;margin-bottom:4px}
.title span{font-weight:600;color:#555}
.promo{margin:6px 0 10px;color:#0b5cff}
.meta{font-size:12px;color:#566}
.empty{padding:12px;color:#666}
</style>
</head>
<body>
<div class="wrap">
  <h1>üè∑Ô∏è Aqu√≠ Nom√°s ‚Äî demo estable (restaurada)</h1>

  <div class="box">
    <div class="row">
      <input id="qall" class="input" autofocus placeholder="Ej: 'almorzar en el centro', 'tornillos en Devoto', 'comiditas'"/>
      <button id="micBtn" class="btn mic" title="Dictar por voz (Chrome/Edge)">üé§</button>
      <button id="goBtn" class="btn">Buscar</button>
      <button id="clearBtn" class="btn ghost">Limpiar</button>
      <button id="locBtn" class="btn secondary" title="Usar mi ubicaci√≥n">üìç Cerca</button>
      <button id="cpyBtn" class="btn secondary" title="Copiar link con la b√∫squeda">Copiar link</button>
    </div>
    <div class="chips" id="chips"></div>
    <div class="tiny" id="gpsHint" style="margin-top:6px;display:none">üìç Usando tu ubicaci√≥n para ordenar por cercan√≠a.</div>
  </div>

  <div id="results" class="box"></div>
</div>

<script>
// === URL de tu Google Sheets PUBLICADO (output=csv) ===
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTsfhmidUT4vOSY5u0TCi_7IlrpRcYi29_VF2-qgQniySHAfG18eNYoyvQ_Bqf0iB6nZaOaSXGBqUXP/pub?gid=0&single=true&output=csv";

// ===== Filtro y normalizaci√≥n =====
const STOP = new Set([
  "hola","buenas","buenos","dias","tardes","noches",
  "necesito","quiero","busco","busca","buscar","buscando","buscaba","comprar","venta",
  "un","una","unos","unas","de","para","con","el","la","los","las","en","por","y","o","a","al","del",
  "estoy","estamos","aca","aqui","ahora","cerca","porfavor","porfa",
  "avenida","av","sobre","altura","calle"
]);
const norm = s => (s||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
function canon(t){ if(t.endsWith('es')&&t.length>4) return t.slice(0,-2); if(t.endsWith('s')&&t.length>4) return t.slice(0,-1); return t; }
function toks(s){ return norm(s).replace(/[^\p{L}\p{N}\s]/gu," ").split(/\s+/).filter(t=>t && !STOP.has(t)).map(canon); }

// ‚Äî‚Äî mapeo intenci√≥n‚Üírubro(s) (SOLO agregu√© comidita/s y gastronom√≠a/gastron√≥mico) ‚Äî‚Äî 
const INTENT2RUBROS = {
  // comida
  "almorzar":["gastronom"], "almuerzo":["gastronom"], "comer":["gastronom"], "comida":["gastronom"],
  "menu":["gastronom"], "men√∫":["gastronom"],
  "gastronomia":["gastronom"], "gastronomico":["gastronom"], "gastronomicos":["gastronom"],
  "comidita":["gastronom"], "comiditas":["gastronom"],
  // ferreter√≠a
  "tornillo":["ferreter"], "clavo":["ferreter"], "ferreteria":["ferreter"],
  // librer√≠a
  "libro":["librer"], "resma":["librer"], "papel":["librer"], "a4":["librer"],
  // florer√≠a
  "flor":["florer"], "floreria":["florer"]
};
// verbos/palabras de acci√≥n
const ACTION_TOKENS = new Set([
  "almorzar","almuerzo","comer","comida","cena","cenar","menu","men√∫",
  "gastronomia","gastronomico","gastronomicos","comidita","comiditas"
]);

// === Helpers varios ===
const keyNorm = k => (k||"").toLowerCase().replace(/[^a-z]/g,"");
function getField(obj, target){ const want=keyNorm(target); for(const k of Object.keys(obj)){ if(keyNorm(k)===want) return obj[k]; } }

function parseCSV(txt){
  const rows = txt.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));
  const head = rows.shift().map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
  return rows.map(r=>Object.fromEntries(head.map((h,i)=>[h,(r[i]||"").trim()])));
}

// === Coordenadas robustas + distancia ===
function parseCoordRaw(v) {
  if (v == null) return NaN;
  let s = String(v).trim().replace(',', '.');
  if (!s) return NaN;
  let n = Number(s);
  if (Number.isNaN(n)) {
    const neg = s.trim().startsWith('-');
    const digits = s.replace(/[^0-9]/g,'');
    if (digits.length >= 7) { n = parseInt(digits,10) / 1e6; if(neg) n = -Math.abs(n); }
    else if (/^\-?\d+$/.test(s)) { n = parseInt(s,10); }
  }
  if (Math.abs(n) > 180) n = n / 1e6;
  return n;
}
function parseLat(v){ const n=parseCoordRaw(v); return Math.abs(n)<=90 ? n : NaN; }
function parseLng(v){ const n=parseCoordRaw(v); return Math.abs(n)<=180 ? n : NaN; }

let USER_POS = null;
function haversineKm(a, b){
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  const A = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.min(1, Math.sqrt(A)));
}

// === Interpretaci√≥n de frase (igual que antes) ===
function understand(raw){
  const t0=(raw||"").trim(), t=norm(t0);
  let zona="", qText=t0;

  let m = t.match(/(?:estoy|vivo|me\s+encuentro)\s+en\s+([a-z√°√©√≠√≥√∫√±\s]+?)(?=\s*(?:y\s+)?(?:busc\w*|necesit\w*|quiero|ir|comer|almorzar|cenar)\b|[,.!?]|$)/i);
  if(!m) m = t.match(/(?:^|\s)(?:en|por|de|sobre)\s+([a-z√°√©√≠√≥√∫√±\s]+?)(?=\s+(?:busc\w*|necesit\w*|quiero|ir|comer|almorzar|cenar)\b|[,.!?]|$)/i);
  if(!m) m = t.match(/(?:almorzar|cenar|comer|buscar|ir|comprar|necesito|quiero)\s+(?:algo\s+)?(?:en|por|sobre)\s+([a-z√°√©√≠√≥√∫√±\s]+)$/i);
  if(!m) m = t.match(/cerca\s+de\s+([a-z√°√©√≠√≥√∫√±\s]+)$/i);

  if(m){
    zona=(m[1]||"").trim().split(/\s+/).slice(0,4).join(" ");
    qText=t0.replace(new RegExp(m[0],'i'),'').trim();
  }

  qText=qText
    .replace(/^(?:hola|buenas|buenos dias|buenas tardes|buenas noches)\b[\s,]*/i,"")
    .replace(/^(?:estoy|estamos|vivo|me\s+encuentro)\b[\s,]*/i,"")
    .replace(/^(?:busc\w*|necesit\w*|quiero)\b[\s,]*/i,"")
    .replace(/^de\s+/i,"").trim();

  return {q:qText,z:zona};
}

// === Zona por barrio/direcci√≥n (igual) ===
function locationMatch(row, zona){
  if(!zona) return true;
  const zt=toks(zona), tb=toks(row.barrio||""), td=toks(row.direccion||"");
  for(const z of zt){
    if(tb.includes(z) || td.includes(z)) return true;
  }
  const nb=norm(row.barrio||""), nd=norm(row.direccion||""), nz=norm(zona);
  return nb.includes(nz) || nd.includes(nz) || nz.includes(nb) || nz.includes(nd);
}

// === CARGA CSV con proxy anti-CORS (igual que tu estable) ===
let DATA = [];
const PROXY = u => 'https://r.jina.ai/' + u.replace(/^https?:\/\//,'https://');

async function fetchCSV(url){
  try{
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok) throw new Error('HTTP ' + r.status);
    return await r.text();
  }catch(e1){
    console.warn('Fetch directo fall√≥:', e1);
    try{
      const r2 = await fetch(PROXY(url), { cache: 'no-store' });
      if(!r2.ok) throw new Error('HTTP ' + r2.status);
      return await r2.text();
    }catch(e2){
      console.error('Fetch via proxy fall√≥:', e2);
      throw e2;
    }
  }
}

(async function load(){
  try{
    const txt = await fetchCSV(CSV_URL);
    DATA = parseCSV(txt);
    console.log('CSV cargado. Filas:', DATA.length);
  }catch(e){
    console.error('Error cargando CSV:', e);
    alert('No pude cargar la base (CSV). Verific√° que est√© "Publicada en la web" y el gid sea el correcto.');
  }
})();

// === UI ===
document.getElementById('goBtn').addEventListener('click', buscar);
document.getElementById('clearBtn').addEventListener('click', ()=>{
  document.getElementById('qall').value="";
  document.getElementById('results').innerHTML="";
  document.getElementById('chips').innerHTML="";
});
document.getElementById('cpyBtn').addEventListener('click', ()=>{
  const inp = document.getElementById('qall').value.trim();
  const u = new URL(location.href);
  if(inp) u.searchParams.set('t', inp); else u.searchParams.delete('t');
  navigator.clipboard.writeText(u.toString()).then(()=>alert('Link copiado'));
});
document.getElementById('qall').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); buscar(); }});
document.getElementById('locBtn').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Tu navegador no soporta geolocalizaci√≥n.'); return; }
  navigator.geolocation.getCurrentPosition(
    pos=>{ USER_POS={lat:pos.coords.latitude,lng:pos.coords.longitude}; document.getElementById('gpsHint').style.display='block'; buscar(); },
    err=>{ alert('No pude obtener tu ubicaci√≥n. Permit√≠ el acceso al GPS.'); },
    { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
  );
});

// === BUSCAR (igual que antes; sin cambios de l√≥gica salvo nuevas palabras) ===
function desiredRubros(tokens){
  const wants=new Set();
  for(const t of tokens){ const rs=INTENT2RUBROS[t]; if(rs) rs.forEach(r=>wants.add(r)); }
  return wants;
}

function buscar(){
  try{
    const raw=document.getElementById('qall').value;
    const {q,z}=understand(raw);
    document.getElementById('chips').innerHTML=[
      z?`<div class="chip"><strong>Zona:</strong> ${z}</div>`:'',
      q?`<div class="chip"><strong>Intenci√≥n:</strong> ${q}</div>`:''
    ].join('');
    render(buscarInterno(q,z));
  }catch(e){ console.error('Error en buscar():', e); alert('Hubo un error al procesar la b√∫squeda.'); }
}

function buscarInterno(q,z){
  const qt=toks(q);
  const wants = desiredRubros(qt);
  const hasAction = qt.some(t=>ACTION_TOKENS.has(t));
  const noIntent = qt.length===0;

  return DATA.map(l=>{
      const rubroNorm = norm(l.rubro||"");
      const blobIntent = norm((l.rubro||"")+" "+(l.keywords||"")); // solo rubro+keywords
      let score = 0;

      // 1) si hay intenci√≥n: exigir rubro compatible o keywords que contengan verbo de acci√≥n
      if(wants.size){
        let ok=false;
        for(const w of wants){ if(rubroNorm.includes(w)) { ok=true; break; } }
        if(!ok && hasAction){
          const verbs = qt.filter(t=>ACTION_TOKENS.has(t));
          if(verbs.some(v=>blobIntent.includes(v))) ok=true;
        }
        if(!ok) score=-1;
      }

      // 2) score por tokens solo contra rubro+keywords (no arrastre por direcci√≥n)
      if(score>=0){ qt.forEach(t=>{ if(blobIntent.includes(t)) score += 1; }); }

      // 3) filtro zona
      if(score>=0 && z && !locationMatch(l,z)) score = -1;

      // 4) bonus cercan√≠a
      const lat=parseLat(getField(l,'lat')), lng=parseLng(getField(l,'lng'));
      let distKm=null;
      if(score>=0 && USER_POS && !isNaN(lat) && !isNaN(lng)){
        distKm=haversineKm(USER_POS,{lat,lng});
        const bonus=Math.max(0, 2 - (distKm/1.5));
        score+=bonus;
      }

      // 5) sin intenci√≥n pero con zona o GPS: dejar pasar m√≠nimo
      if(score===0 && noIntent && (z || USER_POS)) score=0.1;

      return { l:{...l,_distKm:distKm,_plat:lat,_plng:lng}, score };
    })
    .filter(x=>x.score>0)
    .sort((a,b)=>b.score-a.score)
    .slice(0,12)
    .map(x=>x.l);
}

function render(items){
  const box=document.getElementById('results');
  if(!items.length){ box.innerHTML='<div class="empty">No encontr√© opciones. Prob√° con otra palabra o zona.</div>'; return; }
  box.innerHTML=items.map(r=>{
    const name=r.nombre_local||r.nombre||r.local||'(sin nombre)';
    const hasCoords=!isNaN(r._plat)&&!isNaN(r._plng);
    const dest=hasCoords?`${r._plat},${r._plng}`:`${r.direccion||''} ${r.barrio||''}`;
    const maps=USER_P
      ? `https://www.google.com/maps/dir/?api=1&origin=${USER_POS.lat},${USER_POS.lng}&destination=${encodeURIComponent(dest)}&travelmode=walking`
      : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dest)}`;
    const wa=r.whatsapp?("https://wa.me/54"+String(r.whatsapp).replace(/[^0-9]/g,"")):null;
    const dist=(typeof r._distKm==='number')?`<div class="meta">‚âà ${r._distKm.toFixed(2)} km</div>`:'';
    return `<div class="card">
      <div class="title">${name} ‚Äî <span>${r.rubro||''}</span></div>
      <div>${r.direccion||''} ${r.barrio?`(${r.barrio})`:''}</div>
      ${r.horario?`<div class="promo">Horario: ${r.horario}</div>`:''}
      ${r.promo_texto?`<div class="promo">${r.promo_texto}</div>`:''}
      ${dist}
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
        ${wa?`<a class="btn" target="_blank" href="${wa}">WhatsApp</a>`:''}
        <a class="btn secondary" target="_blank" href="${maps}">C√≥mo llegar</a>
      </div>
    </div>`;
  }).join("");
}

// Micr√≥fono (igual)
(function(){
  const btn=document.getElementById('micBtn');
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){btn.disabled=true;btn.innerText='üé§‚Äî';btn.title='Dictado no disponible.';return;}
  const rec=new SR(); rec.lang='es-AR'; rec.interimResults=false; rec.maxAlternatives=1;
  btn.addEventListener('click',()=>{ try{rec.start();btn.innerText='‚è∫Ô∏è';}catch(e){ console.warn('Mic start:',e);} });
  rec.onresult=e=>{ try{ const t=e.results[0][0].transcript||''; document.getElementById('qall').value=t.trim(); buscar(); }catch(err){ console.error('Mic result:',err); } };
  rec.onend=()=>{ btn.innerText='üé§'; };
  rec.onerror=e=>{ console.error('Mic error:',e); btn.innerText='üé§'; };
})();
</script>
</body>
</html>







