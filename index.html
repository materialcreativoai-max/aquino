<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aqu√≠ Nom√°s ‚Äî Demo (frases simples)</title>
<style>
:root{--pri:#0b5cff;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#0b1220}
.wrap{max-width:860px;margin:0 auto;padding:18px}
h1{font-size:20px;margin:0 0 14px}
.box{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:14px;margin:0 0 14px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.input{flex:1;min-width:260px;padding:12px 14px;border:1px solid #cfd6e0;border-radius:12px;font-size:15px}
.btn{padding:12px 14px;border-radius:12px;border:1px solid var(--pri);background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
.btn.secondary{background:#fff;color:var(--pri)}
.btn.ghost{background:#fff;border-color:#cfd6e0;color:#0b1220}
.btn.mic{border:1px dashed var(--pri);background:#eef3ff}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{background:#eef3ff;border:1px solid #d7e3ff;color:#153a9b;padding:6px 10px;border-radius:999px;font-size:12px}
.chip strong{font-weight:700;margin-right:4px}
.tiny{font-size:12px;color:#667}
.card{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:12px;margin:10px 0}
.title{font-weight:700;margin-bottom:4px}
.title span{font-weight:600;color:#555}
.promo{margin:6px 0 10px;color:var(--pri)}
.meta{font-size:12px;color:#566}
.empty{padding:12px;color:#666}
</style>
</head>
<body>
<div class="wrap">
  <h1>üè∑Ô∏è Aqu√≠ Nom√°s ‚Äî demo (frases simples)</h1>

  <div class="box">
    <div class="row">
      <input id="qall" class="input" autofocus placeholder="Ej: 'almorzar', 'tornillos', 'libros', 'flores', 'almorzar en el centro'"/>
      <button id="micBtn" class="btn mic" title="Dictar por voz (Chrome/Edge)">üé§</button>
      <button id="goBtn" class="btn">Buscar</button>
      <button id="clearBtn" class="btn ghost">Limpiar</button>
      <button id="locBtn" class="btn secondary" title="Usar mi ubicaci√≥n">üìç Cerca</button>
      <button id="cpyBtn" class="btn secondary">Copiar link</button>
    </div>
    <div class="chips" id="chips"></div>
    <div class="tiny" id="gpsHint" style="margin-top:6px;display:none">üìç Usando tu ubicaci√≥n para priorizar cercanos.</div>
  </div>

  <div id="results" class="box"></div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTsfhmidUT4vOSY5u0TCi_7IlrpRcYi29_VF2-qgQniySHAfG18eNYoyvQ_Bqf0iB6nZaOaSXGBqUXP/pub?gid=0&single=true&output=csv";

const STOP = new Set(["hola","buenas","buenos","dias","tardes","noches","necesito","quiero","busco","buscar","un","una","de","para","con","el","la","los","las","en","por","y","o","a","al","del","estoy","estamos","aca","aqui","ahora","cerca","porfavor","porfa"]);
const norm = s => (s||"").toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
function canon(t){ if(t.endsWith('es')&&t.length>4)return t.slice(0,-2); if(t.endsWith('s')&&t.length>4)return t.slice(0,-1); return t; }
function toks(s){return norm(s).replace(/[^\p{L}\p{N}\s]/gu," ").split(/\s+/).filter(t=>t&&!STOP.has(t)).map(canon);}

const INTENT2RUBROS = {
  "almorzar":["gastronom"],"almuerzo":["gastronom"],"comer":["gastronom"],"comida":["gastronom"],
  "tornillo":["ferreter"],"clavo":["ferreter"],"ferreteria":["ferreter"],
  "libro":["librer"],"resma":["librer"],"papel":["librer"],"a4":["librer"],
  "flor":["florer"],"floreria":["florer"]
};

const ACTION_TOKENS=new Set(["almorzar","almuerzo","comer","comida","cenar","cena"]);

const keyNorm=k=>(k||"").toLowerCase().replace(/[^a-z]/g,"");
function getField(obj,target){const want=keyNorm(target);for(const k of Object.keys(obj)){if(keyNorm(k)===want)return obj[k];}}

function parseCSV(txt){const rows=txt.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));const head=rows.shift().map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));return rows.map(r=>Object.fromEntries(head.map((h,i)=>[h,(r[i]||"").trim()])))}
function parseCoordRaw(v){if(v==null)return NaN;let s=String(v).trim().replace(',','.');if(!s)return NaN;let n=Number(s);if(Number.isNaN(n)){const neg=s.trim().startsWith('-');const digits=s.replace(/[^0-9]/g,'');if(digits.length>=7){n=parseInt(digits,10)/1e6;if(neg)n=-Math.abs(n);}else if(/^\-?\d+$/.test(s)){n=parseInt(s,10);}}if(Math.abs(n)>180)n=n/1e6;return n;}
function parseLat(v){const n=parseCoordRaw(v);return Math.abs(n)<=90?n:NaN;}
function parseLng(v){const n=parseCoordRaw(v);return Math.abs(n)<=180?n:NaN;}
function haversineKm(a,b){const R=6371,toRad=x=>x*Math.PI/180;const dLat=toRad(b.lat-a.lat),dLng=toRad(b.lng-a.lng);const s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;return 2*R*Math.asin(Math.min(1,Math.sqrt(A)));}
let USER_POS=null;

function understand(raw){
  const t0=(raw||"").trim(), t=norm(t0);
  let zona="", qText=t0;
  let m=t.match(/(?:en|por|de|sobre)\s+([a-z√°√©√≠√≥√∫√±\s]+)$/i);
  if(m){zona=(m[1]||"").trim();qText=t0.replace(new RegExp(m[0],'i'),'').trim();}
  qText=qText.replace(/^(?:hola|buenas|busc\w*|necesit\w*|quiero)\b[\s,]*/i,"").trim();
  return {q:qText,z:zona};
}

function desiredRubros(tokens){const wants=new Set();for(const t of tokens){const rs=INTENT2RUBROS[t];if(rs)rs.forEach(r=>wants.add(r));}return wants;}
function locationMatch(row,zona){if(!zona)return true;const zt=toks(zona),tb=toks(row.barrio||""),td=toks(row.direccion||"");for(const z of zt){if(tb.includes(z)||td.includes(z))return true;}return false;}

let DATA=[];
fetch(CSV_URL).then(r=>r.text()).then(t=>{DATA=parseCSV(t);console.log('CSV cargado:',DATA.length)}).catch(e=>{alert('Error al cargar datos');console.error(e);});

document.getElementById('goBtn').addEventListener('click',buscar);
document.getElementById('clearBtn').addEventListener('click',()=>{document.getElementById('qall').value="";document.getElementById('results').innerHTML="";});
document.getElementById('qall').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();buscar();}});
document.getElementById('locBtn').addEventListener('click',()=>{if(!navigator.geolocation){alert('Tu navegador no soporta GPS');return;}navigator.geolocation.getCurrentPosition(pos=>{USER_POS={lat:pos.coords.latitude,lng:pos.coords.longitude};document.getElementById('gpsHint').style.display='block';buscar();},err=>{alert('No pude obtener ubicaci√≥n');});});

function buscar(){
  const raw=document.getElementById('qall').value;
  const {q,z}=understand(raw);
  document.getElementById('chips').innerHTML=[
    z?`<div class="chip"><strong>Zona:</strong> ${z}</div>`:'',
    q?`<div class="chip"><strong>Intenci√≥n:</strong> ${q}</div>`:''
  ].join('');
  render(buscarInterno(q,z));
}

function buscarInterno(q,z){
  const qt=toks(q);
  const wants=desiredRubros(qt);
  const noIntent=qt.length===0;
  return DATA.map(l=>{
    const rubro=norm(l.rubro||"");
    const blob=norm((l.rubro||"")+" "+(l.keywords||""));
    let score=0;
    if(wants.size){
      let ok=false;for(const w of wants){if(rubro.includes(w)){ok=true;break;}}
      if(!ok)score=-1;
    }
    if(score>=0){qt.forEach(t=>{if(blob.includes(t))score+=1;});}
    if(score>=0&&z&&!locationMatch(l,z))score=-1;
    const lat=parseLat(getField(l,'lat')),lng=parseLng(getField(l,'lng'));
    let dist=null;
    if(score>=0&&USER_POS&&!isNaN(lat)&&!isNaN(lng)){dist=haversineKm(USER_POS,{lat,lng});const bonus=Math.max(0,2-(dist/1.5));score+=bonus;}
    if(noIntent&&USER_POS&&dist!==null)score=1/(dist+1);
    return {l:{...l,_distKm:dist,_plat:lat,_plng:lng},score};
  }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0,10).map(x=>x.l);
}

function render(items){
  const box=document.getElementById('results');
  if(!items.length){box.innerHTML='<div class="empty">No encontr√© opciones. Prob√° con otra palabra o zona.</div>';return;}
  box.innerHTML=items.map(r=>{
    const name=r.nombre_local||r.nombre||r.local||'(sin nombre)';
    const dest=!isNaN(r._plat)&&!isNaN(r._plng)?`${r._plat},${r._plng}`:`${r.direccion||''} ${r.barrio||''}`;
    const maps=USER_POS?`https://www.google.com/maps/dir/?api=1&origin=${USER_POS.lat},${USER_POS.lng}&destination=${encodeURIComponent(dest)}&travelmode=walking`:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dest)}`;
    const wa=r.whatsapp?("https://wa.me/54"+String(r.whatsapp).replace(/[^0-9]/g,"")):null;
    const dist=(typeof r._distKm==='number')?`<div class="meta">‚âà ${r._distKm.toFixed(2)} km</div>`:'';
    return `<div class="card">
      <div class="title">${name} ‚Äî <span>${r.rubro||''}</span></div>
      <div>${r.direccion||''} ${r.barrio?`(${r.barrio})`:''}</div>
      ${r.horario?`<div>Horario: ${r.horario}</div>`:''}
      ${r.promo_texto?`<div class="promo">${r.promo_texto}</div>`:''}
      ${dist}
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
        ${wa?`<a class="btn" target="_blank" href="${wa}">WhatsApp</a>`:''}
        <a class="btn secondary" target="_blank" href="${maps}">C√≥mo llegar</a>
      </div>
    </div>`;
  }).join('');
}

// Mic
(function(){
  const btn=document.getElementById('micBtn');
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){btn.disabled=true;btn.innerText='üé§‚Äî';return;}
  const rec=new SR();rec.lang='es-AR';rec.interimResults=false;rec.maxAlternatives=1;
  btn.addEventListener('click',()=>{try{rec.start();btn.innerText='‚è∫Ô∏è';}catch(e){}});
  rec.onresult=e=>{const t=e.results[0][0].transcript||'';document.getElementById('qall').value=t.trim();buscar();};
  rec.onend=()=>{btn.innerText='üé§';};
})();
</script>
</body>
</html>



