<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aqu√≠ Nom√°s ‚Äî estable (GPS + fallback)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='46' fill='%230b5cff'/%3E%3Ctext x='50' y='58' font-size='42' text-anchor='middle' fill='white' font-family='Arial'%3EAN%3C/text%3E%3C/svg%3E">
<style>
:root{--pri:#0b5cff;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#0b1220}
.wrap{max-width:860px;margin:0 auto;padding:18px}
h1{font-size:20px;margin:0 0 14px}
.box{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:14px;margin:0 0 14px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.input{flex:1;min-width:260px;padding:12px 14px;border:1px solid #cfd6e0;border-radius:12px;font-size:15px}
.btn{padding:12px 14px;border-radius:12px;border:1px solid var(--pri);background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
.btn.secondary{background:#fff;color:var(--pri)}
.btn.ghost{background:#fff;border-color:#cfd6e0;color:#0b1220}
.btn.mic{border:1px dashed var(--pri);background:#eef3ff}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{background:#eef3ff;border:1px solid #d7e3ff;color:#153a9b;padding:6px 10px;border-radius:999px;font-size:12px}
.chip strong{font-weight:700;margin-right:4px}
.tiny{font-size:12px;color:#667}
.card{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:12px;margin:10px 0}
.title{font-weight:700;margin-bottom:4px}
.title span{font-weight:600;color:#555}
.promo{margin:6px 0 10px;color:#0b5cff}
.meta{font-size:12px;color:#566}
.empty{padding:12px;color:#666}
.err{padding:12px;background:#fff3f3;border:1px solid #ffd2d2;color:#7a1a1a;border-radius:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>üè∑Ô∏è Aqu√≠ Nom√°s ‚Äî estable (GPS + fallback)</h1>

  <div class="box">
    <div class="row">
      <input id="qall" class="input" autofocus placeholder="Ej: 'cerca', 'Corrientes y 9 de Julio', 'comiditas'"/>
      <button id="micBtn" class="btn mic" title="Dictar por voz (Chrome/Edge)">üé§</button>
      <button id="goBtn" class="btn">Buscar</button>
      <button id="clearBtn" class="btn ghost">Limpiar</button>
      <button id="locBtn" class="btn secondary" title="Usar mi ubicaci√≥n">üìç Cerca</button>
    </div>
    <div class="chips" id="chips"></div>
    <div class="tiny" id="gpsHint" style="margin-top:6px;display:none">
      üìç Mostrando locales ‚â§ <span id="nearKm">1.5</span> km (auto-expande a 2 y 3 km si hace falta).
    </div>
    <div class="tiny" id="srcHint" style="margin-top:6px;display:none"></div>
  </div>

  <div id="error" style="display:none" class="box err"></div>
  <div id="results" class="box"></div>
</div>

<script>
/* ========= Fuente CSV =========
   - Por defecto usa la URL base (tu Sheet publicado)
   - Puede sobreescribirse con ?csv=... o #csv=...
   - Se agrega cache-busting (?v=timestamp) para evitar cach√© vieja
*/
const DEFAULT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTsfhmidUT4vOSY5u0TCi_7IlrpRcYi29_VF2-qgQniySHAfG18eNYoyvQ_Bqf0iB6nZaOaSXGBqUXP/pub?gid=0&single=true&output=csv";
function getParamCSV(){
  const q = new URLSearchParams(location.search);
  const urlQ = q.get("csv");
  const hash = new URLSearchParams(location.hash.replace(/^#/, ""));
  const urlH = hash.get("csv");
  return (urlQ || urlH || DEFAULT_CSV).trim();
}
const CSV_URL = (()=>{
  const base = getParamCSV();
  const sep = base.includes("?") ? "&" : "?";
  return base + sep + "v=" + Date.now();
})();
/* ============================= */

/* utilidades base */
const STOP = new Set(["hola","buenas","buenos","dias","tardes","noches","necesito","quiero","busco","buscar","comprar","un","una","unos","unas","de","para","con","el","la","los","las","en","por","y","o","a","al","del","estoy","aca","aqui","ahora","porfavor","porfa","avenida","av","sobre","calle","cerca"]);
const norm = s => String(s||"").toLowerCase()
  .normalize("NFD").replace(/\p{Diacritic}/gu,"")
  .replace(/[;,]+/g," ").replace(/\s+/g," ").trim();
function toks(s){return norm(s).replace(/[^\p{L}\p{N}\s]/gu," ").split(/\s+/).filter(t=>t&&!STOP.has(t));}
function parseCSV(txt){
  const rows=txt.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));
  const head=rows.shift().map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
  return rows.map(r=>Object.fromEntries(head.map((h,i)=>[h,(r[i]||"").trim()])));
}
/* alias de calles (tolerante a variantes) */
function aliasPlace(s){
  let t=norm(s);
  t=t.replace(/\bnueva?\b\s+de\s+julio/g,"9 de julio");
  t=t.replace(/\bnueve\s+de\s+julio/g,"9 de julio");
  t=t.replace(/\b9\s*julio\b/g,"9 de julio");
  t=t.replace(/\bcorrs?entes\b/g,"corrientes");
  t=t.replace(/\bcerritto\b/g,"cerrito");
  t=t.replace(/\bsantafe\b/g,"santa fe");
  return t;
}
/* coordenadas muy robustas */
function parseCoord(v){
  if(v==null||v==="") return NaN;
  let s=String(v).trim();
  const isNeg = /^\s*-/.test(s);
  s=s.replace(/,/g,'.');
  const parts = s.split('.');
  if(parts.length>2){ s = parts[0]+'.'+parts.slice(1).join(''); }
  let n = Number(s);
  if(Number.isNaN(n)){
    const digits = s.replace(/[^0-9]/g,'');
    if(digits.length>=7){ n = parseInt(digits,10)/1e6; if(isNeg) n = -Math.abs(n); }
  }
  if(Math.abs(n)>180) n/=1e6;
  return n;
}
function haversineKm(a,b){
  const R=6371,toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat),dLng=toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);
  const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.min(1,Math.sqrt(A)));
}

/* estado */
let USER_POS=null, NEAR_ACTIVE=false;
let NEAR_RADIUS_KM=1.5; // auto-expande a 2 y 3 si hay pocos resultados
let DATA=[], IDX=[], LOADED=false;

/* carga CSV + √≠ndice */
fetch(CSV_URL,{cache:"no-store"})
  .then(r=>{
    if(!r.ok) throw new Error("HTTP "+r.status);
    return r.text();
  })
  .then(t=>{
    DATA=parseCSV(t);
    IDX=DATA.map(row=>{
      const nombre=norm(row.nombre_local||row.nombre||row.local||"");
      const rubro=norm(row.rubro||"");
      const kw=norm(row.keywords||"");
      const dirbar=aliasPlace((row.direccion||"")+" "+(row.barrio||"")).replace(/,+/g," ").replace(/\s+/g," ").trim();
      const lat=parseCoord(row.lat), lng=parseCoord(row.lng);
      return {nombre,rubro,kw,dirbar,lat,lng};
    });
    LOADED=true;
    showSrcHint();
  })
  .catch((e)=>{
    const err=document.getElementById('error');
    err.style.display='block';
    err.innerHTML = "No pude cargar la base (CSV). Verific√°: <ul style='margin:6px 0 0 18px'><li>Que el enlace sea de Google Sheets con ‚ÄòPublicar en la web‚Äô en formato CSV.</li><li>Que est√©s usando la hoja correcta (gid).</li><li>Prob√° abrir el CSV en otra pesta√±a; si carga, peg√° ese URL con ?csv=... en esta p√°gina.</li></ul><div style='margin-top:6px;font-size:12px;color:#666'>Detalle: "+(e.message||e)+"</div>";
  });

function showSrcHint(){
  const u=getParamCSV();
  if(!u) return;
  const el=document.getElementById('srcHint');
  el.style.display='block';
  el.textContent = "Fuente CSV activa: " + u;
}

/* parser de frases */
function understand(raw){
  const t0=(raw||"").trim();
  const t=aliasPlace(t0);
  let zona="", qText=t0, wantsNear=/\bcerca\b/.test(t);

  let m=t.match(/(?:estoy|vivo|me\s+encuentro)?\s*(?:en|por|sobre)\s+([a-z0-9\s]+)$/i);
  if(m){ zona=(m[1]||"").trim(); qText=t0.replace(new RegExp(m[0],'i'),'').trim(); }
  else{
    const words=t.split(/\s+/).filter(Boolean);
    if(words.length>0&&(words.length<=4||t.includes(" y "))){
      zona=t0.trim(); qText="";
    }
  }
  return { q:qText, z:zona, wantsNear };
}

/* match de ubicaci√≥n por zona / intersecci√≥n */
function locationMatch(idx,zona){
  if(!zona) return true;
  const f=IDX[idx].dirbar;
  const zn=aliasPlace(zona);
  if(zn.includes(" y ")){
    const [a,b]=zn.split(" y ").map(x=>norm(x)).filter(Boolean);
    if(!(a&&b)) return false;
    return (f.includes(a) && f.includes(b)) || (f.includes(b) && f.includes(a));
  }
  const zWords=norm(zn).split(/\s+/).filter(Boolean);
  if(zWords.some(w=>f.includes(w))) return true;
  for(let i=0;i<zWords.length-1;i++){
    const bi=zWords[i]+" "+zWords[i+1];
    if(f.includes(bi)) return true;
  }
  return f.includes(norm(zn));
}

/* UI */
document.getElementById('goBtn').addEventListener('click',buscar);
document.getElementById('clearBtn').addEventListener('click',()=>{
  document.getElementById('qall').value="";
  document.getElementById('results').innerHTML="";
  document.getElementById('chips').innerHTML="";
  NEAR_ACTIVE=false; document.getElementById('gpsHint').style.display='none';
  document.getElementById('error').style.display='none';
});
document.getElementById('qall').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();buscar();}});
document.getElementById('locBtn').addEventListener('click',()=>{
  if(!navigator.geolocation){
    USER_POS={lat:-34.6037,lng:-58.3816}; // Obelisco (fallback)
    NEAR_ACTIVE=true;
    document.getElementById('nearKm').textContent=NEAR_RADIUS_KM.toFixed(1);
    document.getElementById('gpsHint').style.display='block';
    buscar();
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    USER_POS={lat:pos.coords.latitude,lng:pos.coords.longitude};
    NEAR_ACTIVE=true;
    document.getElementById('nearKm').textContent=NEAR_RADIUS_KM.toFixed(1);
    document.getElementById('gpsHint').style.display='block';
    buscar();
  },()=>{
    USER_POS={lat:-34.6037,lng:-58.3816}; // Fallback si niega permisos
    NEAR_ACTIVE=true;
    document.getElementById('nearKm').textContent=NEAR_RADIUS_KM.toFixed(1);
    document.getElementById('gpsHint').style.display='block';
    buscar();
  },{enableHighAccuracy:true,timeout:8000,maximumAge:0});
});

/* b√∫squeda */
function buscar(){
  if(!LOADED){ alert("Cargando datos‚Ä¶"); return; }

  const raw=document.getElementById('qall').value;
  let {q,z,wantsNear}=understand(raw);

  // modo CERCA: filtra por radio ignorando zona; si faltan lat/lng, esos √≠tems quedan para b√∫squeda normal
  if(wantsNear || NEAR_ACTIVE){
    if(!USER_POS){ USER_POS={lat:-34.6037,lng:-58.3816}; } // fallback silencioso
    NEAR_ACTIVE=true; z="";
    document.getElementById('gpsHint').style.display='block';
  }

  document.getElementById('chips').innerHTML=[
    z?`<div class="chip"><strong>Zona:</strong> ${z}</div>`:'',
    q?`<div class="chip"><strong>Intenci√≥n:</strong> ${q}</div>`:'',
    (NEAR_ACTIVE&&USER_POS)?`<div class="chip"><strong>Modo:</strong> cercanos</div>`:''
  ].join('');

  render(buscarInterno(q,z));
}

function buscarInterno(q,z){
  const qnorm=norm(q);
  const qt=toks(q);

  if(NEAR_ACTIVE && USER_POS){
    const withDist = DATA.map((row,idx)=>{
      const M=IDX[idx];
      if(!Number.isFinite(M.lat)||!Number.isFinite(M.lng)) return null; // sin coords no entran en "cerca"
      const d=haversineKm(USER_POS,{lat:M.lat,lng:M.lng});
      return {...row,_distKm:d};
    }).filter(Boolean)
      .sort((a,b)=>a._distKm-b._distKm);

    let radius=NEAR_RADIUS_KM;
    let inside = withDist.filter(r=>r._distKm<=radius);
    if(inside.length<2){ radius=2.0; inside = withDist.filter(r=>r._distKm<=radius); }
    if(inside.length<2){ radius=3.0; inside = withDist.filter(r=>r._distKm<=radius); }

    document.getElementById('nearKm').textContent=radius.toFixed(1);
    return inside.slice(0,20);
  }

  // b√∫squeda normal (texto + zona). √çtems sin lat/lng se listan igual, s√≥lo sin "‚âà cuadras"
  return DATA.map((row,idx)=>{
    const M=IDX[idx];
    let score=0;

    if(qnorm && M.nombre===qnorm) score+=10;
    if(qnorm && M.nombre.includes(qnorm)) score+=6;

    qt.forEach(t=>{
      if(M.nombre.includes(t)) score+=3;
      if(M.kw.includes(t))     score+=2;
      if(M.rubro.includes(t))  score+=1;
    });

    if(z && !locationMatch(idx,z)) score=-1;

    let distKm=null;
    if(score>=0 && USER_POS && Number.isFinite(M.lat) && Number.isFinite(M.lng)){
      distKm=haversineKm(USER_POS,{lat:M.lat,lng:M.lng});
      score+=Math.max(0,2-(distKm/1.5));
    }
    return { l:{...row,_distKm:distKm}, score };
  })
  .filter(x=>x.score>0)
  .sort((a,b)=>b.score-a.score)
  .slice(0,30)
  .map(x=>x.l);
}

/* render */
function render(items){
  const box=document.getElementById('results');
  if(!items.length){box.innerHTML='<div class="empty">No encontr√© opciones. Prob√° con otra palabra o zona.</div>';return;}
  box.innerHTML=items.map(r=>{
    const name=r.nombre_local||r.nombre||r.local||'(sin nombre)';
    const maps=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((r.direccion||"")+" "+(r.barrio||""))}`;
    const wa=r.whatsapp?("https://wa.me/54"+String(r.whatsapp).replace(/[^0-9]/g,"")):null;
    const dist=(typeof r._distKm==='number')?`<div class="meta">‚âà ${(r._distKm*10).toFixed(0)} cuadras</div>`:'';
    return `<div class="card">
      <div class="title">${name} ‚Äî <span>${r.rubro||''}</span></div>
      <div>${r.direccion||''} ${r.barrio?`(${r.barrio})`:''}</div>
      ${r.horario?`<div class="promo">Horario: ${r.horario}</div>`:''}
      ${r.promo_texto?`<div class="promo">${r.promo_texto}</div>`:''}
      ${dist}
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
        ${wa?`<a class="btn" target="_blank" href="${wa}">WhatsApp</a>`:''}
        <a class="btn secondary" target="_blank" href="${maps}">C√≥mo llegar</a>
      </div>
    </div>`;
  }).join("");
}

/* mic */
(function(){
  const btn=document.getElementById('micBtn');
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){btn.disabled=true;btn.innerText='üé§‚Äî';btn.title='Dictado no disponible.';return;}
  const rec=new SR();rec.lang='es-AR';rec.interimResults=false;rec.maxAlternatives=1;
  btn.addEventListener('click',()=>{try{rec.start();btn.innerText='‚è∫Ô∏è';}catch(e){}});
  rec.onresult=e=>{const t=e.results[0][0].transcript||'';document.getElementById('qall').value=t.trim();buscar();};
  rec.onend=()=>{btn.innerText='üé§';};
})();
</script>
</body>
</html>
