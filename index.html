<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aqu√≠ Nom√°s ‚Äî estable v4.11</title>
<style>
:root{--pri:#0b5cff;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#0b1220}
.wrap{max-width:880px;margin:0 auto;padding:18px}
h1{font-size:20px;margin:0 0 14px}
.box{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:14px;margin:0 0 14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input{flex:1;min-width:260px;padding:12px 14px;border:1px solid #cfd6e0;border-radius:12px;font-size:15px}
.btn{padding:10px 12px;border-radius:12px;border:1px solid var(--pri);background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
.btn.secondary{background:#fff;color:var(--pri)}
.btn.ghost{background:#fff;border-color:#cfd6e0;color:#0b1220}
.btn.mic{border:1px dashed var(--pri);background:#eef3ff}
.tiny{font-size:12px;color:#667}
.card{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:12px;margin:10px 0}
.title{font-weight:700;margin-bottom:4px}
.title span{font-weight:600;color:#555}
.meta{font-size:12px;color:#566}
.err{padding:8px 10px;background:#fff3f3;border:1px solid #ffd2d2;border-radius:10px;margin-bottom:12px;color:#7a1a1a}
.ok{padding:8px 10px;background:#eef9f1;border:1px solid #cfead8;border-radius:10px;margin-bottom:12px;color:#145a32}
</style>
</head>
<body>
<div class="wrap">
  <h1>üè∑Ô∏è Aqu√≠ Nom√°s ‚Äî estable v4.11</h1>
  <div id="status" class="ok" style="display:none"></div>
  <div id="error" class="err" style="display:none"></div>

  <div class="box">
    <div class="row">
      <input id="qall" class="input" autofocus placeholder="Ej: 'santa fe', 'cerca', 'almorzar en recoleta', 'librer√≠a en el centro'"/>
      <button id="micBtn" class="btn mic" title="Dictar por voz (Chrome/Edge)">üé§</button>
      <button id="goBtn" class="btn">Buscar</button>
      <button id="clearBtn" class="btn ghost">Limpiar</button>
      <button id="locBtn" class="btn secondary" title="Usar mi ubicaci√≥n">üìç Cerca</button>
    </div>
    <div class="tiny" id="gpsHint" style="margin-top:6px;display:none"></div>
  </div>

  <div id="results" class="box"></div>
</div>
<!-- Favicon inline (elimina el 404) -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' fill='%23000'/%3E%3Ctext x='50%25' y='58%25' font-size='36' text-anchor='middle' fill='%23fff'%3EA%3C/text%3E%3C/svg%3E'>

<!-- Limpia storage al cargar (evita ResourceQuotaExceeded) -->
<script src="wipe-storage.js"></script>

<script>
const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSg0UeYMVZj0b9H2V63XS37oXlIwJ6SL4n-m6WJEbspzM5OP9QA3QF6qSw4fr81dw/pub?gid=1861393565&single=true&output=csv";
const STREET_ANCHORS = ["santafe","9dejulio","corrientes"];

// utils
function removeDiacritics(str){return str.normalize("NFD").replace(/[\u0300-\u036f]/g,"");}
function aliasPhrases(s){
  return s
    .replace(/\bsanta\s+fe\b/g,"santafe")
    .replace(/\bsan\s+nicolas\b/g,"sannicolas")
    .replace(/\b9\s*de\s*julio\b/g,"9dejulio");
}
const normRaw = s => aliasPhrases(removeDiacritics(String(s||"").toLowerCase()));
const norm = s => normRaw(s).replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();

function parseCSV(txt){
  const rows=txt.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,"")));
  const head=rows.shift().map(h=>String(h).trim().toLowerCase().replace(/\s+/g,"_"));
  return rows.map(r=>Object.fromEntries(head.map((h,i)=>[h,(r[i]||"").trim()])));
}
function parseCoord(v){
  if(!v)return NaN;
  let s=String(v).trim().replace(/,/g,'.');
  let n=Number(s);
  if(Number.isNaN(n)){
    const digits=s.replace(/[^0-9]/g,'');
    if(digits.length>=7){n=parseInt(digits,10)/1e6;if(/^[-]/.test(s))n=-Math.abs(n);}
  }
  if(Math.abs(n)>180)n/=1e6;
  return n;
}
function haversineKm(a,b){
  const R=6371,toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat),dLng=toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);
  const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.min(1,Math.sqrt(A)));
}

// load
let DATA=[],IDX=[],USER_POS=null,NEAR=false,LOADED=false;
fetch(CSV_URL,{cache:"no-store"})
 .then(r=>r.text())
 .then(t=>{
    if(/^\s*<!doctype/i.test(t))throw new Error("El enlace no devolvi√≥ CSV (HTML).");
    DATA=parseCSV(t);
    IDX=DATA.map(row=>{
      const nombre=norm(row.nombre_local||row.nombre||row.local||"");
      const rubro=norm(row.rubro||"");
      const kw=norm((row.keywords||"")+" "+(row.nombre_local||row.nombre||"")+" "+(row.rubro||"")+" "+(row.barrio||""));
      const dirbar=norm((row.direccion||"")+" "+(row.barrio||""));
      const lat=parseCoord(row.lat),lng=parseCoord(row.lng);
      return{nombre,rubro,kw,dirbar,lat,lng};
    });
    document.getElementById('status').style.display='block';
    document.getElementById('status').textContent="CSV cargado OK ¬∑ filas: "+DATA.length;
    LOADED=true;
 })
 .catch(e=>{
    const el=document.getElementById('error'); el.style.display='block';
    el.textContent="No se pudo leer el CSV. "+(e.message||e);
 });

// search helpers
const STOP=new Set(["hola","buenas","busco","un","una","el","la","en","por","a","al","del","las","los"]);
const BARRIOS=["microcentro","centro","recoleta","palermo","belgrano","caballito","flores","retiro","san nicolas","monserrat","balvanera","almagro","boedo","san telmo","barracas","constitucion","chacarita","villa crespo","colegiales","nunez","saavedra","parque patricios","parque chas"];

function tokenize(raw){
  const qn = norm(raw);
  let t=qn.split(/\s+/).filter(w=>!STOP.has(w));
  t=t.filter(w=>w.length>=3);
  const extra=[];
  if(t.includes("almorzar")||t.includes("almuerzo"))extra.push("almuerzo","menu","comida","gastronomia","restaurante");
  if(t.includes("centro"))extra.push("microcentro","centro");
  return Array.from(new Set(t.concat(extra)));
}
function detectBarrio(q){
  for(const b of BARRIOS){ if(q.includes(b)) return b; }
  const m=q.match(/\ben\s+([a-z0-9\s]{3,})$/);
  return m?m[1].trim():"";
}
function barrioMatch(dirbar,barrioTerm){
  if(!barrioTerm) return true;
  if(barrioTerm==="centro") return dirbar.includes("centro")||dirbar.includes("microcentro");
  return dirbar.includes(barrioTerm);
}

// UI
document.getElementById('goBtn').addEventListener('click',()=>buscar('text'));
document.getElementById('clearBtn').addEventListener('click',()=>{
  document.getElementById('qall').value="";
  document.getElementById('results').innerHTML="";
  document.getElementById('gpsHint').style.display='none';
  NEAR=false;
});
document.getElementById('qall').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();buscar('text');}});
document.getElementById('locBtn').addEventListener('click',()=>{
  const after = ()=>{ NEAR=true; buscar('nearbutton'); };
  if(!navigator.geolocation){ USER_POS={lat:-34.6037,lng:-58.3816}; after(); return; }
  navigator.geolocation.getCurrentPosition(
    p=>{ USER_POS={lat:p.coords.latitude,lng:p.coords.longitude}; after(); },
    ()=>{ USER_POS={lat:-34.6037,lng:-58.3816}; after(); },
    {enableHighAccuracy:true,timeout:8000,maximumAge:0}
  );
});

// mic
(function(){
  const b=document.getElementById('micBtn');
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){b.disabled=true;b.innerText='üé§‚Äî';return;}
  const rec=new SR();rec.lang='es-AR';
  b.addEventListener('click',()=>{try{rec.start();b.innerText='‚è∫Ô∏è';}catch(e){}});
  rec.onresult=e=>{const t=e.results[0][0].transcript||'';document.getElementById('qall').value=aliasPhrases(removeDiacritics(t.toLowerCase()));buscar('text');};
  rec.onend=()=>{b.innerText='üé§';};
})();

// NEAR
function parseNearList(){
  const withDist = DATA.map((row,i)=>{
    const M=IDX[i];
    if(!Number.isFinite(M.lat)||!Number.isFinite(M.lng)) return null;
    const d=haversineKm(USER_POS,{lat:M.lat,lng:M.lng});
    return {row,i,dist:d};
  }).filter(Boolean).sort((a,b)=>a.dist-b.dist);

  let radius=1.5;
  let inside=withDist.filter(o=>o.dist<=radius);
  if(inside.length<3){radius=2.0;inside=withDist.filter(o=>o.dist<=radius);}
  if(inside.length<3){radius=3.0;inside=withDist.filter(o=>o.dist<=radius);}

  const gh=document.getElementById('gpsHint');
  gh.style.display='block';
  gh.textContent="üìç Cercanos dentro de "+radius.toFixed(1)+" km ¬∑ "+inside.length+" resultados";
  return inside.slice(0,40);
}

function buscar(source){
  if(!LOADED){alert("Esper√° que cargue el CSV‚Ä¶");return;}
  const raw=document.getElementById('qall').value||"";
  const qnorm=norm(raw);
  const toks=tokenize(raw);
  const barrioQ=detectBarrio(qnorm);
  const rubroT=toks.find(t=>["gastronomia","libreria","ferreteria","farmacia","kiosco","cafe","panaderia","verduleria","floreria","costureria","heladeria"].includes(t));

  if(source==='text' && !/\bcerca(s|nos)?\b/.test(qnorm)){ NEAR=false; }
  if(/\bcerca(s|nos)?\b/.test(qnorm)){ if(!USER_POS) USER_POS={lat:-34.6037,lng:-58.3816}; NEAR=true; }

  if(NEAR && USER_POS){
    const arr=parseNearList();
    return render(arr.length?arr:[], arr.length?null:'No hay locales cercanos en el radio.');
  }

  // anclas de calle (santafe / 9dejulio / corrientes) sin rubro/barrio ‚Üí exigir match exacto
  const anchor = STREET_ANCHORS.find(a => qnorm.includes(a));
  if (anchor && !rubroT && !barrioQ) {
    NEAR = false;
    const arr = DATA.map((row,i)=>({row,i})).filter(o => IDX[o.i].dirbar.includes(anchor));
    return render(arr.length ? arr : [], arr.length ? null : `No se encontraron resultados sobre ${anchor.replace('9dejulio','9 de julio')}.`);
  }

  if(rubroT && barrioQ){
    const arr=DATA.map((row,i)=>({row,i})).filter(o=>{
      const M=IDX[o.i];
      return M.rubro.includes(rubroT) && barrioMatch(M.dirbar,barrioQ);
    });
    if(!arr.length) return render([],`No se encontraron resultados para ${rubroT} en ${barrioQ}.`);
    return render(arr);
  }

  let arr=DATA.map((row,i)=>({row,i,score:0}));
  if(toks.length){
    arr=arr.map(o=>{
      const M=IDX[o.i]; let s=0;
      toks.forEach(t=>{
        if(M.nombre.includes(t))s+=3;
        if(M.kw.includes(t))s+=2;
        if(M.rubro.includes(t))s+=1;
        if(M.dirbar.includes(t))s+=1;
      });
      return {...o,score:s};
    }).filter(o=>o.score>0).sort((a,b)=>b.score-a.score);
  }
  if(!arr.length) return render([],`No se encontraron resultados para "${raw}".`);
  render(arr.slice(0,40));
}

function render(arr,msg){
  const box=document.getElementById('results');
  if(!arr.length){box.innerHTML=`<div class="tiny">${msg||'Sin resultados.'}</div>`;return;}
  box.innerHTML=arr.map(o=>{
    const r=o.row;
    const name=r.nombre_local||r.nombre||r.local||'(sin nombre)';
    const maps='https://www.google.com/maps/search/?api=1&query='+encodeURIComponent((r.direccion||'')+' '+(r.barrio||''));
    const dist=(typeof o.dist==='number'&&isFinite(o.dist))?`<div class="meta">‚âà ${(o.dist*10).toFixed(0)} cuadras</div>`:'';
    return `<div class="card">
      <div class="title">${name} ‚Äî <span>${r.rubro||''}</span></div>
      <div>${r.direccion||''} ${r.barrio?`(${r.barrio})`:''}</div>
      ${dist}
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
        <a class="btn secondary" target="_blank" href="${maps}">C√≥mo llegar</a>
      </div>
    </div>`;
  }).join("");
}
</script>
</body>
</html>
