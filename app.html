<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Aquí Nomás — estable</title>

  <!-- Evita 404 del /favicon.ico con un favicon inline -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' ry='12' fill='%23000'/%3E%3Ctext x='50%25' y='58%25' font-family='system-ui, -apple-system, Segoe UI, Roboto, Arial' font-size='36' text-anchor='middle' fill='%23fff'%3EA%3C/text%3E%3C/svg%3E">

  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      min-height: 100dvh;
      display: grid;
      place-items: center;
      background: Canvas;
      color: CanvasText;
    }
    .card {
      width: min(780px, 92vw);
      border: 1px solid rgba(0,0,0,.15);
      border-radius: 16px;
      padding: 22px 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    h1 { margin: 0 0 6px }
    .ok { display: inline-block; padding: 6px 10px; border-radius: 999px; background: rgba(0,0,0,.06); }
    .muted { opacity: .7; }
    details { margin-top: 14px }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>

  <script>
    // --- Guardias anti "ResourceQuotaExceeded" ---
    (function () {
      const log = (...a) => console.info("[app:init]", ...a);

      // Limpieza segura de todos los storages
      async function sweepStorages(reason = "") {
        try {
          // sessionStorage y localStorage
          try { sessionStorage.clear(); } catch (e) {}
          try { localStorage.clear(); } catch (e) {}

          // Cache Storage (Service Workers)
          if (self.caches) {
            try {
              const keys = await caches.keys();
              await Promise.allSettled(keys.map(k => caches.delete(k)));
            } catch (e) {}
          }

          // IndexedDB (mejor esfuerzo: enumera si el navegador lo soporta)
          if (self.indexedDB) {
            try {
              if (indexedDB.databases) {
                const dbs = await indexedDB.databases();
                await Promise.allSettled(
                  dbs.map(db => db && db.name ? indexedDB.deleteDatabase(db.name) : Promise.resolve())
                );
              } else {
                ["keyval-store","localforage","sw-cache","workbox-precache","aquinomas-db"]
                  .forEach(name => { try { indexedDB.deleteDatabase(name); } catch (e) {} });
              }
            } catch (e) {}
          }
        } catch (e) {
          console.warn("Limpieza parcial, continuamos:", e);
        } finally {
          if (reason === "hard-reload") location.reload();
        }
      }

      // Test de cuota de localStorage y reacción ante errores
      function quotaTest() {
        try {
          const k = "__quota_test_" + Math.random().toString(36).slice(2);
          const v = "x".repeat(4096);
          for (let i = 0; i < 64; i++) localStorage.setItem(k + "_" + i, v);
          // Limpia basura de la prueba
          Object.keys(localStorage).filter(x => x.startsWith("__quota_test_")).forEach(x => localStorage.removeItem(x));
        } catch (e) {
          if (e && (e.name === "QuotaExceededError" || e.code === 22)) {
            log("Cuota excedida: limpiando storages y recargando…");
            sweepStorages("hard-reload");
          } else {
            console.warn("Aviso de almacenamiento:", e);
          }
        }
      }

      // Hook global para cualquier QuotaExceeded que aparezca después
      window.addEventListener("error", ev => {
        const e = ev.error;
        if (e && (e.name === "QuotaExceededError" || e.code === 22)) {
          ev.preventDefault();
          sweepStorages("hard-reload");
        }
      }, { capture: true });

      // Primera pasada de limpieza mínima al iniciar
      (async () => {
        await sweepStorages();
        quotaTest();
      })();
    })();
  </script>
</head>
<body>
  <main class="card">
    <h1>Aquí Nomás — estable</h1>
    <p class="ok">Aplicación cargada correctamente.</p>
    <details>
      <summary class="muted">Qué hicimos para que no falle más</summary>
      <ul class="muted">
        <li>Favicon inline para evitar <code>GET /favicon.ico 404</code>.</li>
        <li>Limpieza segura de <code>localStorage</code>, <code>sessionStorage</code>, <code>Cache Storage</code> e <code>IndexedDB</code>.</li>
        <li>Detección de <code>QuotaExceededError</code> y recarga automática si hiciera falta.</li>
      </ul>
    </details>
  </main>
</body>
</html>
