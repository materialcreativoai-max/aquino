<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Aquí Nomás — estable</title>

  <!-- Favicon inline -->
  <link rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' fill='%23000'/%3E%3Ctext x='50%25' y='58%25' font-size='36' text-anchor='middle' fill='%23fff'%3EA%3C/text%3E%3C/svg%3E'"/>

  <script>
    // ---------- Limpieza fuerte al entrar ----------
    (async () => {
      try { localStorage.clear(); } catch {}
      try { sessionStorage.clear(); } catch {}

      // Borrar IndexedDB (todas las DB conocidas)
      try {
        if (indexedDB && indexedDB.databases) {
          const dbs = await indexedDB.databases();
          for (const db of dbs) {
            if (!db || !db.name) continue;
            await new Promise(res => {
              const req = indexedDB.deleteDatabase(db.name);
              req.onsuccess = req.onerror = req.onblocked = () => res();
            });
          }
        } else {
          // Fallback: intenta borrar nombres habituales si no existe indexedDB.databases()
          const candidatos = ['keyval-store','workbox-precache-http___','idb-keyval','app-db','localforage'];
          for (const name of candidatos) {
            try { indexedDB.deleteDatabase(name); } catch {}
          }
        }
      } catch {}

      // Desregistrar service workers viejos
      try {
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) { try { await r.unregister(); } catch {} }
        }
      } catch {}
    })();

    // ---------- Guardas de modo seguro ----------
    let recargadoUnaVez = location.hash === '#safe-reloaded';

    function limpiezaYReloadUnaVez(origen) {
      try { localStorage.clear(); } catch {}
      try { sessionStorage.clear(); } catch {}
      try {
        if (indexedDB) { indexedDB.deleteDatabase('keyval-store'); }
      } catch {}
      if (!recargadoUnaVez) {
        recargadoUnaVez = true;
        location.hash = '#safe-reloaded';
        location.reload();
      } else {
        console.warn('Limpieza aplicada dos veces, continúo sin recargar. Origen:', origen);
      }
    }

    // Captura errores globales
    window.addEventListener('error', (e) => {
      if (String(e?.message || '').toLowerCase().includes('quota')) {
        limpiezaYReloadUnaVez('window.error');
      }
    });

    // Captura promesas rechazadas
    window.addEventListener('unhandledrejection', (e) => {
      const msg = String(e?.reason?.message || e?.reason || '').toLowerCase();
      if (msg.includes('quota') || msg.includes('resourcequotaexceeded')) {
        limpiezaYReloadUnaVez('unhandledrejection');
        e.preventDefault?.();
      }
    });

    // Envolturas seguras para setItem (si alguien escribe de más, limpiamos)
    (function(){
      const origSet = Storage.prototype.setItem;
      Storage.prototype.setItem = function(k,v){
        try { return origSet.call(this,k,v); }
        catch (err) {
          if (String(err).toLowerCase().includes('quota')) {
            limpiezaYReloadUnaVez('Storage.setItem');
          }
        }
      };
    })();
  </script>
</head>
<body style="font-family:system-ui, Arial, sans-serif; margin:0; padding:20px;">
  <h1>Aquí Nomás — estable</h1>
  <p>Aplicación cargada correctamente.</p>

  <script>
    // Tu futura lógica de app va acá.
    console.log('Modo ultra-seguro activo. Si algo intenta sobrecargar el storage, se limpia y sigue.');
  </script>
</body>
</html>
