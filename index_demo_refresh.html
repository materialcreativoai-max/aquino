
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aqu√≠ Nom√°s ‚Äî DEMO en vivo (refresco CSV)</title>
<style>
:root{--pri:#0b5cff;}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#0b1220}
.wrap{max-width:880px;margin:0 auto;padding:18px}
h1{font-size:20px;margin:0 0 14px}
.box{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:14px;margin:0 0 14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input{flex:1;min-width:260px;padding:12px 14px;border:1px solid #cfd6e0;border-radius:12px;font-size:15px}
.btn{padding:10px 12px;border-radius:12px;border:1px solid var(--pri);background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
.btn.secondary{background:#fff;color:var(--pri)}
.btn.ghost{background:#fff;border-color:#cfd6e0;color:#0b1220}
.btn.mic{border:1px dashed var(--pri);background:#eef3ff}
.tiny{font-size:12px;color:#667}
.card{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:12px;margin:10px 0}
.title{font-weight:700;margin-bottom:4px}
.title span{font-weight:600;color:#555}
.meta{font-size:12px;color:#566}
.ok{padding:8px 10px;background:#eef9f1;border:1px solid #cfead8;border-radius:10px;margin-bottom:12px;color:#145a32}
.err{padding:8px 10px;background:#fff3f3;border:1px solid #ffd2d2;border-radius:10px;margin-bottom:12px;color:#7a1a1a}
.badge{display:inline-block;padding:4px 8px;background:#eef3ff;border:1px solid #d7e3ff;color:#153a9b;border-radius:999px;font-size:12px;margin-right:6px}
.switch{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#445}
.switch input{transform:scale(1.2)}
</style>
</head>
<body>
<div class="wrap">
  <h1>üè∑Ô∏è Aqu√≠ Nom√°s ‚Äî DEMO en vivo</h1>
  <div id="status" class="ok" style="display:none"></div>
  <div id="error" class="err" style="display:none"></div>

  <div class="box">
    <div class="row">
      <input id="qall" class="input" autofocus placeholder="Ej: 'almorzar en recoleta', 'cerca', 'comiditas'"/>
      <button id="micBtn" class="btn mic" title="Dictar por voz (Chrome/Edge)">üé§</button>
      <button id="goBtn" class="btn">Buscar</button>
      <button id="clearBtn" class="btn ghost">Limpiar</button>
      <button id="locBtn" class="btn secondary" title="Usar mi ubicaci√≥n">üìç Cerca</button>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="refreshBtn" class="btn">Actualizar datos</button>
      <label class="switch"><input id="autoChk" type="checkbox"/> Auto (15s)</label>
      <div class="tiny" id="srcHint"></div>
      <div class="tiny" id="tsHint" style="margin-left:auto;text-align:right"></div>
    </div>
    <div class="tiny" id="gpsHint" style="margin-top:6px;display:none">
      üìç Mostrando ‚â§ <span id="nearKm">1.5</span> km (auto-expande a 2 y 3 km si hace falta).
    </div>
    <div class="tiny" id="intentHint" style="margin-top:6px;display:none"></div>
  </div>

  <div id="results" class="box"></div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSg0UeYMVZj0b9H2V63XS37oXlIwJ6SL4n-m6WJEbspzM5OP9QA3QF6qSw4fr81dw/pub?gid=1861393565&single=true&output=csv";
const STATUS = document.getElementById('status');
const ERR = document.getElementById('error');
const SRC = document.getElementById('srcHint');
const TSH = document.getElementById('tsHint');
SRC.textContent = "Fuente CSV: " + CSV_URL;

// utils
function removeDiacritics(str){ return str.normalize("NFD").replace(/[\u0300-\u036f]/g,""); }
const norm = s => removeDiacritics(String(s||"").toLowerCase()).replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();
function parseCSV(txt){
  const rows = txt.trim().split(/\r?\n/).map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g,'')));
  const head = rows.shift().map(h => String(h).trim().toLowerCase().replace(/\s+/g,'_'));
  return rows.map(r => Object.fromEntries(head.map((h,i) => [h, (r[i]||"").trim()])));
}
function parseCoord(v){
  if(v==null||v==="") return NaN;
  let s = String(v).trim(); const isNeg = /^\s*-/.test(s);
  s = s.replace(/,/g,'.'); const parts = s.split('.');
  if(parts.length>2) s = parts[0]+'.'+parts.slice(1).join('');
  let n = Number(s);
  if(Number.isNaN(n)){ const digits = s.replace(/[^0-9]/g,''); if(digits.length>=7){ n = parseInt(digits,10)/1e6; if(isNeg) n = -Math.abs(n); } }
  if(Math.abs(n)>180) n/=1e6; return n;
}
function haversineKm(a,b){
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  const A=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.min(1,Math.sqrt(A)));
}

// state
let DATA=[], IDX=[], LOADED=false;
let USER_POS=null, NEAR=false;
let refreshTimer=null;

async function loadCSV(){
  try{
    STATUS.style.display='none'; ERR.style.display='none';
    const cacheBust = Date.now();
    const resp = await fetch(CSV_URL + "&_t="+cacheBust, {cache:"no-store"});
    const txt = await resp.text();
    if(/^\s*<!doctype\s+html/i.test(txt)) throw new Error("El enlace no devolvi√≥ CSV (lleg√≥ HTML).");
    const data = parseCSV(txt);
    const idx = data.map(row=>{
      const nombre = norm(row.nombre_local||row.nombre||row.local||"");
      const rubro  = norm(row.rubro||"");
      const kw     = norm((row.keywords||"")+" "+(row.nombre_local||row.nombre||row.local||"")+" "+(row.rubro||"")+" "+(row.barrio||""));
      const dirbar = norm((row.direccion||"")+" "+(row.barrio||""));
      const lat=parseCoord(row.lat), lng=parseCoord(row.lng);
      return {nombre,rubro,kw,dirbar,lat,lng};
    });
    DATA=data; IDX=idx; LOADED=true;
    const ts = new Date();
    STATUS.style.display='block'; STATUS.textContent = "CSV cargado OK ¬∑ filas: "+DATA.length;
    TSH.textContent = "Cargado a las " + ts.toLocaleTimeString();
  }catch(e){
    ERR.style.display='block'; ERR.textContent = "No se pudo leer el CSV. " + (e.message||e);
  }
}

// stopwords + sin√≥nimos + barrios
const STOP = new Set(["","hola","buenas","buenos","dias","tardes","noches","necesito","quiero","busco","buscar","comprar","un","una","unos","unas","de","para","con","el","la","los","las","en","por","y","o","a","al","del","estoy","aca","aqui","ahora","porfavor","porfa","avenida","av","sobre","calle"]);
const BARRIOS = ["microcentro","centro","recoleta","palermo","belgrano","caballito","flores","retiro","san nicolas","monserrat","balvanera","almagro","boedo","san telmo","barracas","constitucion","chacarita","villa crespo","colegiales","nunez","saavedra","parque patricios","parque chas"];

function tokenize(raw){
  let t = norm(raw).split(/\s+/).filter(w=>!STOP.has(w));
  const extra = [];
  if(t.includes("almorzar")||t.includes("almuerzo")||t.includes("almuerzos")) extra.push("almuerzo","menu","comida","gastronomia","restaurante","almorzar");
  if(t.includes("centro")) extra.push("microcentro","centro");
  return Array.from(new Set(t.concat(extra)));
}
function detectBarrio(qnorm){
  for(const b of BARRIOS){ if(qnorm.includes(b)) return b; }
  const m = qnorm.match(/\ben\s+([a-z0-9\s]{3,})$/);
  if(m){ return m[1].trim(); }
  return "";
}
function barrioMatch(dirbar, barrioTerm){
  if(!barrioTerm) return true;
  if(barrioTerm==="centro") return (dirbar.includes("centro") || dirbar.includes("microcentro"));
  return dirbar.includes(barrioTerm);
}

// UI hooks
document.getElementById('goBtn').addEventListener('click',buscar);
document.getElementById('clearBtn').addEventListener('click',()=>{
  document.getElementById('qall').value=""; document.getElementById('results').innerHTML="";
  NEAR=false; document.getElementById('gpsHint').style.display='none';
  document.getElementById('intentHint').style.display='none';
});
document.getElementById('qall').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); buscar(); } });
document.getElementById('locBtn').addEventListener('click',()=>{
  if(!navigator.geolocation){ USER_POS={lat:-34.6037,lng:-58.3816}; NEAR=true; document.getElementById('gpsHint').style.display='block'; buscar(); return; }
  navigator.geolocation.getCurrentPosition(pos=>{ USER_POS={lat:pos.coords.latitude,lng:pos.coords.longitude}; NEAR=true; document.getElementById('gpsHint').style.display='block'; buscar(); },()=>{ USER_POS={lat:-34.6037,lng:-58.3816}; NEAR=true; document.getElementById('gpsHint').style.display='block'; buscar(); },{enableHighAccuracy:true,timeout:8000,maximumAge:0});
});
document.getElementById('refreshBtn').addEventListener('click',()=>{ loadCSV(); });
document.getElementById('autoChk').addEventListener('change',e=>{
  if(e.target.checked){
    loadCSV();
    refreshTimer = setInterval(loadCSV, 15000);
  }else{
    clearInterval(refreshTimer);
  }
});

// mic
(function(){
  const btn=document.getElementById('micBtn');
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ btn.disabled=true; btn.innerText='üé§‚Äî'; btn.title='Dictado no disponible en este navegador.'; return; }
  const rec=new SR(); rec.lang='es-AR'; rec.interimResults=false; rec.maxAlternatives=1;
  btn.addEventListener('click',()=>{ try{ rec.start(); btn.innerText='‚è∫Ô∏è'; }catch(e){} });
  rec.onresult=e=>{ const t=e.results[0][0].transcript||''; document.getElementById('qall').value=t.trim(); buscar(); };
  rec.onend=()=>{ btn.innerText='üé§'; };
})();

function nearSearch(){
  const list = DATA.map((row,idx)=>{
    const M=IDX[idx];
    if(!Number.isFinite(M.lat)||!Number.isFinite(M.lng)) return null;
    const d=haversineKm(USER_POS,{lat:M.lat,lng:M.lng});
    return {row, idx, dist:d};
  }).filter(Boolean).sort((a,b)=>a.dist-b.dist);

  let radius=1.5;
  let inside=list.filter(o=>o.dist<=radius);
  if(inside.length<3){ radius=2.0; inside=list.filter(o=>o.dist<=radius); }
  if(inside.length<3){ radius=3.0; inside=list.filter(o=>o.dist<=radius); }

  document.getElementById('nearKm').textContent=radius.toFixed(1);
  document.getElementById('gpsHint').textContent = "üìç Mostrando ‚â§ " + radius.toFixed(1) + " km.";
  document.getElementById('gpsHint').style.display='block';
  return inside.slice(0,40);
}

function buscar(){
  if(!LOADED){ alert("Esper√° que cargue el CSV‚Ä¶"); return; }
  const rawQ = document.getElementById('qall').value || "";
  const qnorm = norm(rawQ);
  const toks = tokenize(rawQ);

  // activar "cerca" por texto
  if(/\bcerca(s|nos)?\b/.test(qnorm)){
    if(!USER_POS){ USER_POS={lat:-34.6037,lng:-58.3816}; }
    NEAR=true;
  }

  if(NEAR && USER_POS){
    return render(nearSearch());
  }

  // INTENCI√ìN ALMORZAR EN {BARRIO}
  const wantsLunch = /(almorzar|almuerzo|men[u√∫]|comida|restaurante|gastronom[√≠i]a)/i.test(rawQ);
  const barrioQ = detectBarrio(qnorm);
  if(wantsLunch && barrioQ){
    const lunch = DATA.map((row,idx)=>({row,idx})).filter(o=>{
      const M=IDX[o.idx];
      const isGastro = (M.rubro.includes("gastronomia") || /(almuerzo|menu|comida|restaurante)/.test(M.kw));
      return isGastro && barrioMatch(M.dirbar, barrioQ);
    });
    const ih = document.getElementById('intentHint');
    ih.style.display='block'; ih.innerHTML = '<span class="badge">Intenci√≥n</span> almorzar ¬∑ barrio: <strong>'+barrioQ+'</strong>';
    return render(lunch.slice(0,40));
  }

  // scoring general
  let items = DATA.map((row,idx)=>({ row,idx,score:0 }));
  if(toks.length){
    items = items.map(o=>{
      const M=IDX[o.idx]; let sc=0;
      toks.forEach(t=>{
        if(M.nombre.includes(t)) sc+=3;
        if(M.kw.includes(t)) sc+=2;
        if(M.rubro.includes(t)) sc+=1;
        if(M.dirbar.includes(t)) sc+=1;
      });
      return {...o,score:sc};
    }).filter(o=>o.score>0).sort((a,b)=>b.score-a.score);
  }

  render(items.slice(0,40));
}

function render(arr){
  const box=document.getElementById('results');
  if(!arr.length){ box.innerHTML='<div class="tiny">Sin resultados. Prob√° otra palabra o zona.</div>'; return; }
  box.innerHTML = arr.map(o=>{
    const r=o.row;
    const name=r.nombre_local||r.nombre||r.local||'(sin nombre)';
    const maps='https://www.google.com/maps/search/?api=1&query='+encodeURIComponent((r.direccion||'')+' '+(r.barrio||''));
    const dist=(typeof o.dist==='number' && isFinite(o.dist))?('<div class="meta">‚âà '+(o.dist*10).toFixed(0)+' cuadras</div>'):'';
    return `
      <div class="card">
        <div class="title">${name} ‚Äî <span>${r.rubro||''}</span></div>
        <div>${r.direccion||''} ${r.barrio?`(${r.barrio})`:''}</div>
        ${dist}
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <a class="btn secondary" target="_blank" href="${maps}">C√≥mo llegar</a>
        </div>
      </div>
    `;
  }).join("");
}

// initial load
loadCSV();
</script>
</body>
</html>
