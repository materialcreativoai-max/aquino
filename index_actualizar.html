<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aqu√≠ Nom√°s ‚Äî DEMO (im√°genes ajustadas)</title>
<style>
:root{--pri:#0b5cff;}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f9fb;color:#0b1220}
.wrap{max-width:900px;margin:0 auto;padding:18px}
h1{font-size:20px;margin:0 0 14px}
.box{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:14px;margin:0 0 14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input{flex:1;min-width:260px;padding:12px 14px;border:1px solid #cfd6e0;border-radius:12px;font-size:15px}
.btn{padding:10px 12px;border-radius:12px;border:1px solid var(--pri);background:var(--pri);color:#fff;font-weight:600;cursor:pointer}
.btn.secondary{background:#fff;color:var(--pri)}
.btn.ghost{background:#fff;border-color:#cfd6e0;color:#0b1220}
.btn.mic{border:1px dashed var(--pri);background:#eef3ff}
.tiny{font-size:12px;color:#667}
.card{background:#fff;border:1px solid #e6e9ee;border-radius:14px;padding:12px;margin:10px 0;overflow:hidden;text-align:center}
.title{font-weight:700;margin:8px 0 4px}
.title span{font-weight:600;color:#555}
.meta{font-size:12px;color:#566}
.thumb{max-height:150px;width:auto;object-fit:contain;border-radius:12px;background:#f1f3f7;display:block;margin:0 auto 10px auto;box-shadow:0 1px 4px rgba(0,0,0,0.1)}
.err{padding:8px 10px;background:#fff3f3;border:1px solid #ffd2d2;border-radius:10px;margin-bottom:12px;color:#7a1a1a}
.ok{padding:8px 10px;background:#eef9f1;border:1px solid #cfead8;border-radius:10px;margin-bottom:12px;color:#145a32}
</style>
</head>
<body>
<div class="wrap">
  <h1>üè∑Ô∏è Aqu√≠ Nom√°s ‚Äî DEMO (im√°genes ajustadas)</h1>
  <div id="status" class="ok" style="display:none"></div>
  <div id="error" class="err" style="display:none"></div>

  <div class="box">
    <div class="row">
      <input id="qall" class="input" placeholder="Ej: 'santa fe', 'cerca', 'almorzar en recoleta'"/>
      <button id="micBtn" class="btn mic" title="Dictar por voz (Chrome/Edge)">üé§</button>
      <button id="goBtn" class="btn">Buscar</button>
      <button id="clearBtn" class="btn ghost">Limpiar</button>
      <button id="locBtn" class="btn secondary" title="Usar mi ubicaci√≥n">üìç Cerca</button>
      <button id="refreshBtn" class="btn" title="Volver a leer el CSV">Actualizar datos</button>
    </div>
    <div class="tiny" id="gpsHint" style="margin-top:6px;display:none"></div>
  </div>

  <div id="results" class="box"></div>
</div>

<script>
const qs=(k)=>new URLSearchParams(location.search).get(k);
const CSV_PARAM=qs('csv');
const CSV_FALLBACK="https://docs.google.com/spreadsheets/d/e/2PACX-1vSg0UeYMVZj0b9H2V63XS37oXlIwJ6SL4n-m6WJEbspzM5OP9QA3QF6qSw4fr81dw/pub?gid=1861393565&single=true&output=csv";
const BASE_CSV=CSV_PARAM||CSV_FALLBACK;

function removeDiacritics(s){return s.normalize("NFD").replace(/[\u0300-\u036f]/g,"");}
function aliasPhrases(s){return s.replace(/\bsanta\s+fe\b/g,"santafe").replace(/\b9\s*de\s*julio\b/g,"9dejulio");}
const norm=s=>aliasPhrases(removeDiacritics(String(s||"").toLowerCase())).replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();

function parseCSV(txt){
  const rows=txt.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,"")));
  const head=rows.shift().map(h=>String(h).trim().toLowerCase().replace(/\s+/g,"_"));
  return rows.map(r=>Object.fromEntries(head.map((h,i)=>[h,(r[i]||"").trim()])));
}
function csvURL(){return BASE_CSV+(BASE_CSV.includes("?")?"&":"?")+"v="+Date.now();}

let DATA=[],IDX=[],LOADED=false;
function loadCSV(){
  const st=document.getElementById("status");
  st.style.display="block";st.textContent="Cargando CSV‚Ä¶";
  return fetch(csvURL(),{cache:"no-store"})
  .then(r=>r.text())
  .then(t=>{
    if(/^\s*<!doctype/i.test(t)) throw new Error("El enlace no devolvi√≥ CSV (HTML).");
    DATA=parseCSV(t);
    IDX=DATA.map(row=>{
      const nombre=norm(row.nombre_local||row.nombre||row.local||"");
      const rubro=norm(row.rubro||"");
      const kw=norm((row.keywords||"")+" "+(row.nombre_local||row.nombre||"")+" "+(row.rubro||"")+" "+(row.barrio||""));
      const dirbar=norm((row.direccion||"")+" "+(row.barrio||""));
      const img=(row.imagen_url||"").trim();
      return {nombre,rubro,kw,dirbar,img};
    });
    st.textContent="CSV cargado OK ¬∑ filas: "+DATA.length;
    LOADED=true;
  })
  .catch(e=>{
    const el=document.getElementById("error");el.style.display="block";el.textContent="No se pudo leer el CSV. "+(e.message||e);
  });
}

document.getElementById("goBtn").addEventListener("click",buscar);
document.getElementById("clearBtn").addEventListener("click",()=>{document.getElementById("qall").value="";document.getElementById("results").innerHTML="";});
document.getElementById("refreshBtn").addEventListener("click",()=>{LOADED=false;loadCSV().then(()=>{if(document.getElementById("qall").value.trim())buscar();});});

function buscar(){
  if(!LOADED){alert("Esper√° que cargue el CSV‚Ä¶");return;}
  const q=norm(document.getElementById("qall").value);
  const arr=DATA.map((row,i)=>({row,i})).filter(o=>{
    const M=IDX[o.i];
    return M.nombre.includes(q)||M.rubro.includes(q)||M.kw.includes(q)||M.dirbar.includes(q);
  });
  render(arr);
}

function safeImg(u){
  if(!u) return "";
  const s=String(u).trim();
  if(!/^https?:\/\//i.test(s)) return "";
  return s+(s.includes("?")?"&":"?")+"t="+Date.now()%999999;
}
function render(arr){
  const box=document.getElementById("results");
  if(!arr.length){box.innerHTML='<div class="tiny">Sin resultados.</div>';return;}
  box.innerHTML=arr.map(o=>{
    const r=o.row;
    const name=r.nombre_local||r.nombre||r.local||"(sin nombre)";
    const maps="https://www.google.com/maps/search/?api=1&query="+encodeURIComponent((r.direccion||"")+" "+(r.barrio||""));
    const imgURL=safeImg(r.imagen_url);
    const imgTag=imgURL?`<img class="thumb" loading="lazy" src="${imgURL}" alt="${name}" onerror="this.style.display='none'">`:"";
    return `<div class="card">
      ${imgTag}
      <div class="title">${name} ‚Äî <span>${r.rubro||""}</span></div>
      <div>${r.direccion||""} ${r.barrio?`(${r.barrio})`:""}</div>
      <div style="margin-top:8px;">
        <a class="btn secondary" target="_blank" href="${maps}">C√≥mo llegar</a>
      </div>
    </div>`;
  }).join("");
}
loadCSV();
</script>
</body>
</html>
